var ai=Object.create;var Qe=Object.defineProperty,li=Object.defineProperties,pi=Object.getOwnPropertyDescriptor,ui=Object.getOwnPropertyDescriptors,di=Object.getOwnPropertyNames,rs=Object.getOwnPropertySymbols,mi=Object.getPrototypeOf,os=Object.prototype.hasOwnProperty,ci=Object.prototype.propertyIsEnumerable;var ss=(t,e,r)=>e in t?Qe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,P=(t,e)=>{for(var r in e||(e={}))os.call(e,r)&&ss(t,r,e[r]);if(rs)for(var r of rs(e))ci.call(e,r)&&ss(t,r,e[r]);return t},T=(t,e)=>li(t,ui(e)),ns=t=>Qe(t,"__esModule",{value:!0});var ie=(t,e)=>{ns(t);for(var r in e)Qe(t,r,{get:e[r],enumerable:!0})},fi=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of di(e))!os.call(t,o)&&o!=="default"&&Qe(t,o,{get:()=>e[o],enumerable:!(r=pi(e,o))||r.enumerable});return t},v=t=>fi(ns(Qe(t!=null?ai(mi(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);ie(exports,{ActionType:()=>H,BailSeriesHook:()=>ze,ExecuteHook:()=>Ie,Hook:()=>Ke,HookCancel:()=>S,HttpSymbolKind:()=>R,LogLevel:()=>E,OnRequestHook:()=>be,OnResponseHook:()=>Re,OnStreaming:()=>Ee,ParseEndRegionHook:()=>Rt,ParseHook:()=>bt,ProtoDefinition:()=>Ct,ProvideEnvironmentsHook:()=>xt,ProvideVariablesHook:()=>vt,RepeatOrder:()=>ve,ReplaceVariableHook:()=>kt,ResponseLoggingHook:()=>wt,SeriesHook:()=>ae,VariableType:()=>V,WaterfallHook:()=>yt,actions:()=>Zr,cli:()=>ts,getEnvironments:()=>Na,getVariables:()=>zn,io:()=>Ir,isProcessorContext:()=>$e,parser:()=>Oo,send:()=>Qt,store:()=>Qo,testSymbols:()=>le,utils:()=>Tr,variables:()=>Wo});var Ir={};ie(Ir,{Logger:()=>pt,fileProvider:()=>f,gotHttpClientFactory:()=>Ls,initHttpClient:()=>Er,log:()=>m,userInteractionProvider:()=>O});var f={exists:()=>{throw new Error("Not Implemented")},dirname:()=>{throw new Error("Not Implemented")},isAbsolute:()=>{throw new Error("Not Implemented")},joinPath:()=>{throw new Error("Not Implemented")},readFile:()=>{throw new Error("Not Implemented")},readBuffer:()=>{throw new Error("Not Implemented")},writeBuffer:()=>{throw new Error("Not Implemented")},readdir:()=>{throw new Error("Not Implemented")},fsPath:is,toString:is};function is(t){return typeof t=="string"?t:t.toString()}var S=Symbol("cancel hook run"),Ke=class{constructor(e){this.bailOut=e;this.id=this.constructor.name,this.items=[],this.interceptors=[]}hasHook(e){return this.items.some(r=>r.id===e)}addHook(e,r,o){let s=P({id:e,action:r},o);if(s.before){let n=Math.min(...this.getIndeces(s.before));if(n>=0){this.items.splice(n,0,s);return}}if(s.after){let n=Math.max(...this.getIndeces(s.after));if(n>=0){this.items.splice(n+1,0,s);return}}this.items.push(s)}getIndeces(e){return e.map(r=>this.items.findIndex(o=>o.id===r)).filter(r=>r>=0)}addObjHook(e,...r){for(let o of r)this.addHook(o.id,e(o).bind(o),o)}removeHook(e){let r=this.items.findIndex(o=>o.id===e);return r>=0?(this.items.splice(r,1),!0):!1}addInterceptor(e){this.interceptors.push(e)}removeInterceptor(e){let r=this.interceptors.indexOf(e);return r>=0?(this.interceptors.splice(r,1),!0):!1}async trigger(e,r,o){let s=[],n={index:0,length:this.items.length,arg:e};if(await this.intercept(i=>i.beforeLoop,n)===!1)return S;for(;n.index<n.length;){n.hookItem=this.items[n.index],m.trace(`${this.id}: ${n.hookItem.id} started`);try{if(await this.intercept(a=>a.beforeTrigger,n)===!1)return S;let i=await n.hookItem.action(n.arg,r,o);if(i===S)return S;if(this.bailOut&&this.bailOut(i))return s.push(i),this.getMergedResults(s,e);if(s.push(i),n.arg=this.getNextArg(i,e),await this.intercept(a=>a.afterTrigger,n)===!1)return S;n.index++}catch(i){throw m.error(`${this.id}: ${n.hookItem.id} failed`),i}}return await this.intercept(i=>i.afterLoop,n)===!1?S:this.getMergedResults(s,e)}async intercept(e,r){for(let o of this.interceptors){let s=e(o);if(s&&!await s.apply(o,[r]))return!1}return!0}},ae=class extends Ke{constructor(e){super(e)}getNextArg(e,r){return r}getMergedResults(e){return e}},ze=class extends Ke{constructor(e){super(e)}getNextArg(e,r){return r}getMergedResults(e){return e.pop()}},yt=class extends Ke{constructor(e){super(e)}getNextArg(e){return e}getMergedResults(e,r){return e.pop()||r}};var bt=class extends ze{constructor(){super(e=>!!e);this.id="ParseHook"}},Rt=class extends ae{constructor(){super();this.id="ParseEndRegionHook"}},vt=class extends ae{constructor(){super();this.id="ProvideVariablesHook"}},xt=class extends ae{constructor(){super();this.id="ProvideEnvironmentsHook"}},kt=class extends yt{constructor(){super(e=>e===void 0);this.id="ReplaceVariableHook"}},be=class extends ae{constructor(){super();this.id="BeforeRequestHook"}},Re=class extends ae{constructor(){super();this.id="AfterRequestHook"}},Ee=class extends ae{constructor(){super();this.id="OnStreaming"}},wt=class extends ze{constructor(){super();this.id="ResponseLoggingHook"}},Ie=class extends ae{constructor(){super(e=>!e);this.id="ExecuteHook"}};var H;(function(y){y.cookieJar="cookieJar",y.defaultHeaders="defaultHeaders",y.eventSourceClient="eventSourceClient",y.intellij="intellij",y.gql="gql",y.loop="loop",y.js="js",y.protoImport="protoImport",y.protoCreate="protoCreate",y.grpcClient="grpcClient",y.httpClient="httpClient",y.import="import",y.ref="ref",y.variable="variable",y.websocketClient="websocketClient"})(H||(H={}));var R;(function(b){b.request="request",b.requestLine="requestLine",b.requestHeader="requestHeader",b.requestBody="requestBody",b.response="response",b.gql="gql",b.proto="proto",b.script="script",b.metaData="metaData",b.comment="comment",b.url="url",b.operator="operator",b.key="key",b.value="value",b.variable="variable",b.text="text"})(R||(R={}));var E;(function(i){i[i.trace=1]="trace",i[i.debug=2]="debug",i[i.warn=5]="warn",i[i.info=10]="info",i[i.error=100]="error",i[i.none=1e3]="none"})(E||(E={}));function $e(t){let e=t;return!!(e==null?void 0:e.httpClient)&&!!(e==null?void 0:e.httpFile)&&!!(e==null?void 0:e.variables)&&!!(e==null?void 0:e.config)}var Ct=class{constructor(e){this.fileName=e;this.loaderOptions={}}};var ve;(function(r){r[r.sequential=0]="sequential",r[r.parallel=1]="parallel"})(ve||(ve={}));var le={ok:"\u2713",error:"\u2716"};var V;(function(s){s.variable="Variable",s.url="Url",s.body="Body",s.filePath="FilePath"})(V||(V={}));var Tr={};ie(Tr,{ENVIRONMENT_NONE:()=>fs,JAVASCRIPT_KEYWORDS:()=>ms,assertHasNoResponseBody:()=>cr,assertHasResponseBody:()=>mr,assertHeaderContains:()=>dr,assertHeaderEquals:()=>ur,assertMaxTotalTime:()=>pr,assertResponseBodyEquals:()=>fr,assertResponsetimeLower:()=>Ri,assertStatusEquals:()=>lr,clearModule:()=>Rr,cloneResponse:()=>Ht,decodeJWT:()=>Oe,defaultConfigFiles:()=>Ot,deleteHeader:()=>ir,evalExpression:()=>z,executeGlobalScripts:()=>Me,expandVariable:()=>qr,expandVariables:()=>Le,extensionName:()=>gr,findRootDir:()=>ot,findRootDirOfFile:()=>hr,getDisplayName:()=>at,getHeader:()=>F,getHeaderArray:()=>He,getHttpacConfig:()=>xr,getMarkdownSyntax:()=>vs,getPlugins:()=>kr,getRegionDescription:()=>Pr,isError:()=>wr,isEventSourceRequest:()=>or,isGlobalHttpRegion:()=>lt,isGrpcRequest:()=>nr,isHttpRegionSendContext:()=>Hr,isHttpRegionsSendContext:()=>Sr,isHttpRequest:()=>K,isHttpRequestMethod:()=>Pt,isMQTTRequest:()=>sr,isMimeTypeCSS:()=>Zt,isMimeTypeFormUrlEncoded:()=>tt,isMimeTypeHtml:()=>Xt,isMimeTypeImage:()=>hi,isMimeTypeJSON:()=>Xe,isMimeTypeJavascript:()=>Yt,isMimeTypeMarkdown:()=>et,isMimeTypeMultiPartFormData:()=>er,isMimeTypeNewlineDelimitedJSON:()=>tr,isMimeTypePdf:()=>gi,isMimeTypeXml:()=>Ze,isProcessorContext:()=>Oi,isPromise:()=>Fe,isString:()=>c,isStringEmpty:()=>G,isValidVariableName:()=>nt,isWebsocketRequest:()=>rr,joinMarkdown:()=>Lt,loadModule:()=>St,logResponse:()=>N,parseContentType:()=>Se,parseError:()=>Cr,parseJson:()=>it,parseMimeType:()=>Ye,processHttpRegionActions:()=>ke,replaceFilePath:()=>ye,replaceInvalidChars:()=>vi,replaceVariables:()=>de,report:()=>w,requestLoggerFactory:()=>ar,resolveClientCertficates:()=>cs,resolveModule:()=>br,runScript:()=>De,setAdditionalResponseBody:()=>rt,setVariableInContext:()=>Q,shortenFileName:()=>xi,sleep:()=>ue,stateGenerator:()=>Ae,toAbsoluteFilename:()=>D,toEnvironmentKey:()=>W,toHttpString:()=>Li,toHttpStringHeader:()=>Or,toHttpStringRequest:()=>ys,toHttpStringResponse:()=>hs,toMarkdown:()=>qi,toMarkdownHeader:()=>Lr,toMarkdownMeta:()=>ws,toMarkdownRequest:()=>xs,toMarkdownResponse:()=>Rs,toMarkdownTestResults:()=>ks,toMarkdownTimings:()=>Cs,toMultiLineArray:()=>xe,toMultiLineString:()=>j,toNumber:()=>zt,toProcessedHttpRegion:()=>gs,toQueryParams:()=>B,triggerRequestResponseHooks:()=>ne,unsetVariableInContext:()=>qe});var pe=v(require("assert"));var as=v(require("os"));function j(t){return t.join(as.EOL)}function xe(t){return t.split(/\r?\n/gu)}function c(t){return typeof t=="string"}function zt(t,e){if(t){let r=Number.parseInt(t,10);if(!Number.isNaN(r))return r}return e}function G(t){return typeof t=="string"&&/^(\s*)?$/u.test(t)}function Ae(t=30){let e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",r=[];for(let o=t;o>0;--o)r.push(e[Math.floor(Math.random()*e.length)]);return r.join("")}function Ye(t){var s;let[e,...r]=t.split(";").map(n=>n.trim()),o=(s=r.find(n=>n.startsWith("charset=")))==null?void 0:s.split("=")[1];return{mimeType:e,contentType:t,charset:o}}function Xe(t){return!!t&&(t.mimeType==="application/json"||t.mimeType.indexOf("+json")>=0||t.mimeType.indexOf("x-amz-json")>=0)}function Yt(t){return(t==null?void 0:t.mimeType)==="application/javascript"||(t==null?void 0:t.mimeType)==="text/x-javascript"}function Ze(t){return!!t&&(t.mimeType==="application/xml"||t.mimeType==="text/xml"||t.mimeType.indexOf("+xml")>=0)}function Xt(t){return(t==null?void 0:t.mimeType)==="text/html"}function Zt(t){return(t==null?void 0:t.mimeType)==="text/css"}function et(t){return(t==null?void 0:t.mimeType)==="text/markdown"}function er(t){return(t==null?void 0:t.mimeType)==="multipart/form-data"}function tr(t){return(t==null?void 0:t.mimeType)==="application/x-ndjson"}function tt(t){return(t==null?void 0:t.mimeType)==="application/x-www-form-urlencoded"}function gi(t){return(t==null?void 0:t.mimeType)==="application/pdf"}function hi(t){return t?["image/jpeg","image/gif","image/webp","image/png","image/bmp"].indexOf(t.mimeType)>=0:!1}var se=v(require("chalk"));var ls=v(require("xml-formatter")),ps=v(require("util"));function Pt(t){return t?["GET","POST","PUT","DELETE","PATCH","HEAD","OPTIONS","CONNECT","TRACE","PROPFIND","PROPPATCH","MKCOL","COPY","MOVE","LOCK","UNLOCK","CHECKOUT","CHECKIN","REPORT","MERGE","MKACTIVITY","MKWORKSPACE","VERSION-CONTROL","BASELINE-CONTROL"].includes(t.toUpperCase()):!1}function K(t){return Pt(t==null?void 0:t.method)}function rr(t){return(t==null?void 0:t.method)==="WS"}function or(t){return(t==null?void 0:t.method)==="SSE"}function sr(t){return(t==null?void 0:t.method)==="MQTT"}function nr(t){return(t==null?void 0:t.method)==="GRPC"}function ir(t,...e){if(t)for(let r of e){let o=Object.entries(t).find(([s])=>s.toLowerCase()===r.toLowerCase());o&&o.length>1&&delete t[o[0]]}}function F(t,e){if(t){let r=Object.entries(t).find(([o])=>o.toLowerCase()===e.toLowerCase());if(r&&r.length>1)return r[1]}}function He(t,e){let r=F(t,e);if(r)return c(r)?[r]:r}function Se(t){let e=F(t,"content-type");if(c(e))return Ye(e)}function Oe(t){try{let e=t.split(".");if(e.length!==3)return null;let r=e[1];switch(r=r.replace(/-/gu,"+"),r=r.replace(/_/gu,"/"),r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:return null}let o=new ps.TextDecoder().decode(Buffer.from(r,"base64"));return JSON.parse(o)}catch(e){return m.warn(e),null}}function B(t){return Object.entries(t).filter(([,e])=>!!e).map(([e,r])=>`${e}=${encodeURIComponent(r||"")}`).join("&")}function ar(t,e,r){return async function(s,n){var a,l,p,d,u,h,x,q;let i=e;if(r&&(n==null?void 0:n.testResults)&&n.testResults.some(y=>!y.result)&&(i=r),!(i.onlyFailed&&(!(n==null?void 0:n.testResults)||n.testResults.every(y=>y.result))))if(t(""),t("---------------------"),t(""),(((a=n==null?void 0:n.metaData)==null?void 0:a.title)||((l=n==null?void 0:n.metaData)==null?void 0:l.description))&&(((p=n==null?void 0:n.metaData)==null?void 0:p.title)&&t(se.default`{gray === ${n.metaData.title} ===}`),((d=n==null?void 0:n.metaData)==null?void 0:d.description)&&t(se.default`{gray ${n.metaData.description}}`),t("")),i.useShort)t(se.default`{yellow ${((u=s.request)==null?void 0:u.method)||"GET"}} {gray ${((h=s.request)==null?void 0:h.url)||"?"}}`),t(se.default`{gray =>} {cyan.bold ${s.statusCode}} ({yellow ${((x=s.timings)==null?void 0:x.total)||"?"} ms}, {yellow ${((q=s.meta)==null?void 0:q.size)||"?"}})`);else{let y=[];if(s.request&&i.requestOutput&&y.push(...yi(s.request,{headers:i.requestHeaders,bodyLength:i.requestBodyLength})),i.responseHeaders&&(y.length>0&&y.push(""),y.push(...bi(s))),c(s.body)&&i.responseBodyLength!==void 0){y.length>0&&y.push("");let b=s.body;e.responseBodyPrettyPrint&&s.prettyPrintBody&&(b=s.prettyPrintBody),b=us(b,i.responseBodyLength),y.push(b)}t(j(y))}}}function us(t,e){let r=t;return e>0&&(r=t.slice(0,Math.min(t.length,e)),t.length>=e&&(r+=`... (${t.length-e} characters  more)`)),r}function yi(t,e){var o,s;let r=[];return r.push(se.default`{cyan.bold ${t.method} ${t.url}}`),t.headers&&e.headers&&r.push(...Object.entries(t.headers).map(([n,i])=>se.default`{yellow ${n}}: ${i}`).sort()),K(t)&&(((o=t.https)==null?void 0:o.certificate)||((s=t.https)==null?void 0:s.pfx))&&r.push(se.default`{yellow client-cert}: true`),c(t.body)&&e.bodyLength!==void 0&&(r.push(""),r.push(se.default`{gray ${us(t.body,e.bodyLength)}}`)),r}function bi(t){let e=[];return e.push(se.default`{cyan.bold ${t.protocol}} {cyan.bold ${t.statusCode}} {bold ${t.statusMessage?` - ${t.statusMessage}`:""}}`),t.headers&&e.push(...Object.entries(t.headers).filter(([r])=>!r.startsWith(":")).map(([r,o])=>se.default`{yellow ${r}}: ${o}`).sort()),e}function Ht(t){let e={protocol:t.protocol,statusCode:t.statusCode,statusMessage:t.statusMessage,httpVersion:t.httpVersion,headers:t.headers,body:t.body,rawBody:t.rawBody,parsedBody:t.parsedBody,prettyPrintBody:t.prettyPrintBody,contentType:t.contentType,timings:t.timings,meta:t.meta};return t.request&&(e.request=P({},t.request)),e}function rt(t,e){var r;if(c(t.body)&&t.body.length>0){let o=((r=e==null?void 0:e.config)==null?void 0:r.requestPrettyPrintBodyMaxSize)||1e6;if(Xe(t.contentType))try{t.parsedBody||(t.parsedBody=JSON.parse(t.body)),!t.prettyPrintBody&&t.body.length<o&&(t.prettyPrintBody=JSON.stringify(t.parsedBody,null,2))}catch(s){m.warn("json parse error",t.body,s)}else if(Ze(t.contentType)&&!t.prettyPrintBody&&t.body.length<o)try{t.prettyPrintBody=(0,ls.default)(t.body,{collapseContent:!0,indentation:"  "})}catch(s){m.warn("xml format error",t.body,s)}}}async function ne(t,e){var r;try{if(e.request&&await e.httpFile.hooks.onRequest.trigger(e.request,e)===S||e.request&&await e.httpRegion.hooks.onRequest.trigger(e.request,e)===S)return!1;let o=await t();if(o){if(await e.httpRegion.hooks.onResponse.trigger(o,e)===S||await e.httpFile.hooks.onResponse.trigger(o,e)===S)return!1;e.httpRegion.response=o}return!0}catch(o){throw m.error((r=e.request)==null?void 0:r.url,e.request,o),o}}function lr(t,e){(0,pe.strictEqual)(t.statusCode,e,`response status equals to ${e}`)}function pr(t,e){var r;(0,pe.ok)(((r=t.timings)==null?void 0:r.total)?t.timings.total<e:!0,`total time exceeded ${e}`)}function ur(t,e,r){let o=F(t.headers,e);(0,pe.strictEqual)(o,r,`response header equals ${r}`)}function dr(t,e,r){let o=F(t.headers,e);(c(o)||Array.isArray(o))&&(0,pe.ok)(o.indexOf(r),`response header contains ${r}`)}function Ri(t,e){var r;((r=t.timings)==null?void 0:r.total)&&(0,pe.ok)(t.timings.total<=e,`response time lower ${e}`)}function mr(t){(0,pe.ok)(!!t.body,"response body exists")}function cr(t){(0,pe.ok)(!t.body,"response body does not exists")}function fr(t,e){(0,pe.strictEqual)(t.body,e,`response body equals ${e}`)}async function D(t,e,r=!1){if(t){if(await f.isAbsolute(t)&&await f.exists(t))return t;if(e){let o=e;if(r||(o=f.dirname(e)||e),c(t)){let s=f.joinPath(o,t);if(await f.exists(s))return s}}}}function gr(t){let e=f.toString(t),r=e.lastIndexOf(".");if(r>0&&r<e.length-2)return e.slice(r+1)}function vi(t){return t.replace(/[/\\?%*:|"<>]/gu,"_").split("_").filter(r=>r.length>0).join("_")}function xi(t,e=50){let r=[],o=0;for(let n of t.split("_").reverse())n.length+o<e?(r.push(n),o+=n.length+1):r.length===0&&r.push(n);let s=r.reverse().join("_");return s.slice(Math.max(s.length-e,0))}async function hr(t,e,...r){let o=t;return!await f.isAbsolute(t)&&e&&(o=f.joinPath(e,f.fsPath(t))),await ot(f.dirname(o),...r)}async function ot(t,...e){if(t){let r=await f.readdir(t);if(r.some(o=>e.indexOf(o)>=0))return t;for(let o of e)if(r.some(s=>o.startsWith(s))){let s=f.joinPath(t,o);if(await f.exists(s))return f.dirname(s)}if(f.dirname(t)!==t)return ot(f.dirname(t),...e)}}var st=v(require("path")),je=v(require("module")),yr=v(require("vm"));function Fe(t){let e=t;return e&&!!e.then}function ue(t){return new Promise(e=>setTimeout(e,t))}var ds=v(require("os"));function br(t,e){let r;try{try{r=je.default.createRequire(st.default.resolve(e,"package.json")).resolve(t)}catch{r=require.resolve(t,{paths:[e]})}}catch(o){m.debug(o)}return r}function St(t,e,r=!1){try{return r&&Rr(t,e),je.default.createRequire(st.default.resolve(e,"package.json"))(t)}catch{let s=br(t,e);if(s)return r&&vr(s),require(s)}}function ki(t,e){let r=new je.default(t,require.main);return r.filename=t,r.paths=je.default._nodeModulePaths(st.default.dirname(t)),e&&r._compile(e,t),r}function Rr(t,e){let r=br(t,e);r&&vr(r)}function vr(t,e=new Map){let r=require.cache[t];r&&(e.set(t,!0),r.children.forEach(o=>{e.get(o.id)||vr(o.id,e)}),delete require.cache[t])}async function De(t,e){let r=f.fsPath(e.fileName),o=ki(r);function s(l){return e.require&&e.require[l]?e.require[l]:o.require(l)}let n=yr.default.createContext(P(T(P({},global),{Buffer,process,requireUncached:l=>{let p=f.dirname(r);return p&&Rr(l,f.fsPath(p)),o.require(l)}}),e.context));yr.default.runInContext(je.default.wrap(`${ds.EOL}${t}`),n,{filename:r,lineOffset:e.lineOffset,displayErrors:!0}).apply(n,[o.exports,s,o,r,st.default.dirname(r)]);let a=o.exports;if(Fe(a))a=await a;else for(let[l,p]of Object.entries(a))Fe(p)&&(a[l]=await p);return a}async function z(t,e){let r=`exports.$result = (${t});`,o=e.httpRegion.symbol.startLine;if(e.httpRegion.symbol.source){let n=xe(e.httpRegion.symbol.source).findIndex(i=>i.indexOf(t)>=0);n>=0&&(o+=n)}return(await De(r,{fileName:e.httpFile.fileName,context:P({httpFile:e.httpFile,httpRegion:e.httpRegion,console:e.scriptConsole},e.variables),lineOffset:o})).$result}var ms=["await","break","case","catch","class","const","continue","debugger","default","delete","do","else","enum","export","extends","false","finally","for","function","if","implements","import","in","instanceof","interface","let","new","null","package","private","protected","public","return","super","switch","static","this","throw","try","true","typeof","var","void","while","with","yield"];function nt(t){if(ms.indexOf(t)<=0)try{return Function(`var ${t}`),!0}catch{return!1}return!1}async function xr(t){var r;let e=await wi(t);return e||(e=(r=await it(f.joinPath(t,"package.json")))==null?void 0:r.httpyac),e&&await cs(e,t),e}var Ot=[".httpyac.js",".httpyac.config.js",".httpyac.json","httpyac.config.json"];async function wi(t){let e;for(let r of Ot){let o=r&&f.joinPath(t,r);if(o&&await f.exists(o)){e=o;break}}if(e){let r=St(f.fsPath(e),f.fsPath(t),!0);return typeof r=="function"?r():r}}async function it(t){try{let e=await f.readFile(t,"utf-8");return JSON.parse(e)}catch{m.debug(`json parse of ${t} failed`)}}async function cs(t,e){if(t.clientCertificates)for(let[,r]of Object.entries(t.clientCertificates))r.cert&&(r.cert=await D(r.cert,e,!0)||r.cert),r.key&&(r.key=await D(r.key,e,!0)||r.key),r.pfx&&(r.pfx=await D(r.pfx,e,!0)||r.pfx)}async function kr(t){let e=await Ci(t),r={};if(e==null?void 0:e.json){let o=[...Object.keys(e.json.dependencies||{}),...Object.keys(e.json.devDependencies||{})].filter(Pi);for(let s of o){let n=St(s,f.fsPath(e.dir));n&&(r[s]=n)}}return r}async function Ci(t){let e=await ot(t,"package.json");if(e)return{dir:e,json:await it(f.joinPath(e,"package.json"))}}function Pi(t){return/^(httpyac-|@[\w-]+(\.)?[\w-]+\/httpyac-)plugin-/u.test(t)}var fs="__NONE__";function W(t){return t&&t.length>0?t.sort().join(","):fs}function wr(t){if(!t)return!1;if(t instanceof Error)return!0;let e=t;return!!e.message&&!!e.stack&&!!e.name}function Cr(t){var e;if(t.stack){let r=/^(?<error>.*):\s*(?<message>.*)\r?\n\s*at (?<file>.*):(?<line>\d*):(?<offset>\d*)/mu.exec(t.stack);if(r&&((e=r.groups)==null?void 0:e.error))return{error:t,errorType:r.groups.error,message:r.groups.message,file:r.groups.file,line:r.groups.line,offset:r.groups.offset,displayMessage:`${r.groups.error}: ${r.groups.message} - ${r.groups.file}:${r.groups.line}:${r.groups.offset}`}}return{error:t,displayMessage:t.message}}function at(t,e="global"){var r,o,s,n;if(t){if(t.metaData.title)return t.metaData.title;if(t.metaData.name)return t.metaData.name;if((r=t.request)==null?void 0:r.url){let i=t.request.url.indexOf("?");i<0&&(i=t.request.url.length);let a=((n=(s=(o=t.symbol.children)==null?void 0:o.find)==null?void 0:s.call(o,l=>l.kind===R.requestLine))==null?void 0:n.startLine)||t.symbol.startLine;return`${t.request.method} ${t.request.url.slice(0,i)} (line: ${a+1})`}}return e}function Pr(t,e="-"){var r;return t.metaData.description?t.metaData.description:((r=t.request)==null?void 0:r.url)?`${t.request.method} ${t.request.url}`:e}async function ke(t,e){var o,s,n,i,a;delete t.httpRegion.response,delete t.httpRegion.testResults;let r=t.variables;try{(s=(o=t.scriptConsole)==null?void 0:o.collectMessages)==null||s.call(o),t.progress&&(t.showProgressBar=e),((n=t.progress)==null?void 0:n.report)&&t.progress.report({message:`${t.httpRegion.symbol.name}`}),t.variables=Hi(t);let l=await t.httpRegion.hooks.execute.trigger(t),p=gs(t);return p.response=await N(p==null?void 0:p.response,t),t.processedHttpRegions&&!lt(t.httpRegion)&&t.processedHttpRegions.push(p),delete t.httpRegion.response,l!==S&&l.every(d=>!!d)}finally{if(!t.httpRegion.metaData.noLog){(a=(i=t.scriptConsole)==null?void 0:i.flush)==null||a.call(i);let l=t.variables;t.variables=r,Si(l,t)}}}function Hi(t){var o,s;let e=W(t.httpFile.activeEnvironment),r=Object.assign({},t.variables,...(((o=t.config)==null?void 0:o.useRegionScopedVariables)?t.httpFile.httpRegions.filter(n=>lt(n)):t.httpFile.httpRegions).map(n=>n.variablesPerEnv[e]));return((s=t.config)==null?void 0:s.useRegionScopedVariables)?Object.assign(r,...t.httpFile.httpRegions.filter(n=>lt(n)).map(n=>n.variablesPerEnv[e])):Object.assign(r,...t.httpFile.httpRegions.map(n=>n.variablesPerEnv[e])),r}function Si(t,e){for(let[r,o]of Object.entries(t))e.variables[r]||(e.variables[r]=o)}async function N(t,e){if(t){let r=Ht(t);return await e.httpFile.hooks.responseLogging.trigger(r,e)===S?void 0:(!e.httpRegion.metaData.noLog&&r&&e.logResponse&&await e.logResponse(r,e.httpRegion),r)}return t}async function Me(t){for(let e of t.httpFile.httpRegions)if(lt(e)&&!e.metaData.disabled&&!await ke(T(P({},t),{httpRegion:e})))return!1;return!0}function gs(t){return{metaData:t.httpRegion.metaData&&P({},t.httpRegion.metaData),symbol:t.httpRegion.symbol,testResults:t.httpRegion.testResults,request:t.httpRegion.request&&P({},t.httpRegion.request),response:t.httpRegion.response&&Ht(t.httpRegion.response)}}function lt(t){return!(t.request||t.metaData.name)}function Hr(t){let e=t;return!!(e==null?void 0:e.httpRegion)}function Sr(t){let e=t;return Array.isArray(e==null?void 0:e.httpRegions)}function Oi(t){let e=t;return!!e.httpRegion&&!!e.variables&&!!e.options}function Li(t,e){let r=[];return t.request&&(r.push(...ys(t.request,{body:!!(e==null?void 0:e.requestBody)})),r.push("")),r.push(...hs(t,{prettyPrint:!!(e==null?void 0:e.prettyPrint),body:!!(e==null?void 0:e.responseBody)})),j(r)}function hs(t,e){let r=[];return r.push(`${t.protocol} ${t.statusCode} ${t.statusMessage?` - ${t.statusMessage}`:""}`),t.headers&&r.push(...Or(t.headers)),(e==null?void 0:e.body)&&c(t.body)&&(r.push(""),r.push((e==null?void 0:e.prettyPrint)&&t.prettyPrintBody?t.prettyPrintBody:t.body)),r}function ys(t,e){let r=[];return r.push(`${t.method} ${t.url}`),t.headers&&r.push(...Or(t.headers)),(e==null?void 0:e.body)&&c(t.body)&&(r.push(""),r.push(t.body)),r}function Or(t){return Object.entries(t).map(([e,r])=>{let o=r||"";return r&&(Array.isArray(r)?o=r.join(", "):c(r)||(o=JSON.stringify(r))),`${e}: ${o}`})}function w(t,e){var r,o;m.debug(e),(o=(r=t.progress)==null?void 0:r.report)==null||o.call(r,{message:e})}var bs=v(require("os"));function qi(t,e){let r=[];return t.request&&(r.push(...xs(t.request,{body:!!(e==null?void 0:e.requestBody)})),r.push("")),r.push(...Rs(t,{prettyPrint:!!(e==null?void 0:e.prettyPrint),body:!!(e==null?void 0:e.responseBody)})),(e==null?void 0:e.testResults)&&(r.push(""),r.push(""),r.push(...ks(e.testResults))),(e==null?void 0:e.timings)&&t.timings&&(r.push(""),r.push(""),r.push(...Cs(t.timings))),(e==null?void 0:e.meta)&&t.meta&&(r.push(""),r.push(""),r.push(...ws(t.meta))),Lt(r)}function Rs(t,e){let r=[];return r.push(`\`${t.protocol} ${t.statusCode}${t.statusMessage?` - ${t.statusMessage}`:""}\``),t.headers&&r.push(...Lr(t.headers)),(e==null?void 0:e.body)&&c(t.body)&&(r.push(""),r.push(`\`\`\`${vs(t.contentType)}`),r.push(Lt(xe(e.prettyPrint&&t.prettyPrintBody?t.prettyPrintBody:t.body))),r.push("```")),r}function vs(t){return Xe(t)?"json":Ze(t)?"xml":Xt(t)?"html":Yt(t)?"js":Zt(t)?"css":et(t)?"markdown":""}function xs(t,e){let r=[];return r.push(`\`${t.method} ${t.url}\``),t.headers&&r.push(...Lr(t.headers)),(e==null?void 0:e.body)&&c(t.body)&&(r.push(""),r.push("```json"),r.push(Lt(xe(t.body))),r.push("```")),r}function ks(t){let e=[];e.push("`TestResults`"),e.push("");for(let r of t){let o=`${r.result?le.ok:le.error}: ${r.message}`;r.error&&(o+=` (${r.error.displayMessage})`),e.push(o)}return e}function Lr(t){return Object.entries(t).map(([e,r])=>{let o=r||"";return r&&(Array.isArray(r)?o=r.join(", "):c(r)||(o=JSON.stringify(r))),`*${e}*: ${o}`}).sort()}function ws(t){let e=[];e.push("`Meta`"),e.push("");for(let[r,o]of Object.entries(t))Array.isArray(o)?o.length>0&&e.push(`*${r}*: ${o.join(",")}`):e.push(`*${r}*: ${o}`);return e}function Cs(t){let e=[];return e.push("`Timings`"),e.push(""),t.wait&&e.push(`*Wait*: ${t.wait} ms`),t.dns&&e.push(`*DNS*: ${t.dns} ms`),t.tcp&&e.push(`*TCP*: ${t.tcp} ms`),t.tls&&e.push(`*TLS*: ${t.tls} ms`),t.request&&e.push(`*Reqeust*: ${t.request} ms`),t.firstByte&&e.push(`*First Byte*: ${t.firstByte} ms`),t.download&&e.push(`*Download*: ${t.download} ms`),t.total&&e.push(`*Total*: ${t.total} ms`),e}function Lt(t){return t.join(`  ${bs.EOL}`)}function Le(t){for(let[e,r]of Object.entries(t))qr(e,r,t);return t}function qr(t,e,r){if(e&&c(e)){let o=e,s,n=/\{{2}([a-zA-Z0-9_]+)\}{2}/gu;for(;(s=n.exec(o))!==null;){let[i,a]=s,l=qr(a,r[a],r);o=o.replace(i,`${l}`)}r[t]=o}else r[t]=e;return e}async function de(t,e,r){var o,s;return((s=(o=r.progress)==null?void 0:o.isCanceled)==null?void 0:s.call(o))?(m.trace("processs canceled by user"),S):await r.httpFile.hooks.replaceVariable.trigger(t,e,r)}async function ye(t,e,r){var s,n,i,a;let o=await de(t,V.filePath,e);if(c(o)){let l=await D(o,e.httpFile.fileName);if(l)return await r(l);let p=`file not found: ${t}`;(n=(s=O).showWarnMessage)==null||n.call(s,p),m.warn(p)}else{let l=`file replace made file invalid: ${t} <> ${o}`;(a=(i=O).showWarnMessage)==null||a.call(i,l),m.warn(l)}}function Q(t,e){Object.assign(e.variables,t);let r=W(e.httpFile.activeEnvironment);e.httpRegion.variablesPerEnv[r]||(e.httpRegion.variablesPerEnv[r]={}),Object.assign(e.httpRegion.variablesPerEnv[r],t)}function qe(t,e){let r=W(e.httpFile.activeEnvironment),o=e.httpRegion.variablesPerEnv[r];for(let s of Object.keys(t))delete e.variables[s],o&&delete o[s]}var ut=v(require("got")),Ps=v(require("lodash/merge")),Hs=v(require("http-proxy-agent")),Ss=v(require("https-proxy-agent")),Os=v(require("filesize"));var pt=class{constructor(e){this.options=e}collectMessages(){this.collectCache=[]}flush(){if(this.collectCache){for(let e of this.collectCache)e();delete this.collectCache}}writeLog(e,r,o){var s,n;if(!((s=this.options)==null?void 0:s.level)||e>=this.options.level){let i=((n=this.options)==null?void 0:n.logMethod)?()=>{var a,l;return(l=(a=this.options)==null?void 0:a.logMethod)==null?void 0:l.call(a,e,...o)}:()=>r(...o);this.collectCache?this.collectCache.push(i):i()}}info(...e){this.writeLog(E.info,console.info,e)}log(...e){this.writeLog(E.info,console.log,e)}trace(...e){this.writeLog(E.trace,this.options.noTrace?console.debug:console.trace,e)}debug(...e){this.writeLog(E.debug,console.debug,e)}error(...e){this.writeLog(E.error,console.error,e)}warn(...e){this.writeLog(E.warn,console.warn,e)}logTest(e,r){var o;!((o=this.options)==null?void 0:o.onlyFailedTests)&&e?this.writeLog(E.info,console.info,[r]):e||this.writeLog(E.info,console.error,[r])}clear(){console.clear()}},m=new pt({level:E.warn,noTrace:!0});function Ls(t){return async function(o,s){try{let n={decompress:!0,retry:0,throwHttpErrors:!1,headers:{accept:"*/*","user-agent":"httpyac"}},i=o.url;if(!i)throw new Error("empty url");let a=(0,Ps.default)({},n,t,o);delete a.url,Ii(a);let l=e(a);m.debug("request",l);let p;if(s.repeat&&s.repeat.count>0?p=await Ti(i,l,s):p=await Ei(i,l,s),p)return p;throw new Error("no response")}catch(n){if(n instanceof ut.CancelError)return!1;throw n}};function e(r){let o={};return Object.assign(o,r),o}}async function Ti(t,e,r){var i,a;let o=async()=>qs(await(0,ut.default)(t,e)),s=[];for(let l=0;l<(((i=r.repeat)==null?void 0:i.count)||1);l++)s.push(o);if(((a=r.repeat)==null?void 0:a.type)===ve.parallel)return(await Promise.all(s.map(p=>p()))).pop();let n=[];for(let l of s)n.push(await l());return n.pop()}async function Ei(t,e,r){let o=(0,ut.default)(t,e),s=0;r.showProgressBar&&o.on("downloadProgress",a=>{var p;let l=a.percent-s;s=a.percent,((p=r.progress)==null?void 0:p.report)&&r.progress.report({message:"call http request",increment:l*100})});let n=r.progress&&r.progress.register(()=>{o.cancel()}),i=await o;return n&&n(),qs(i)}function Ii(t){t.proxy&&(t.agent={http:new Hs.HttpProxyAgent(t.proxy),https:new Ss.HttpsProxyAgent(t.proxy)},delete t.proxy)}function qs(t){let e={statusCode:t.statusCode,protocol:`HTTP/${t.httpVersion}`,statusMessage:t.statusMessage,body:t.body,rawBody:t.rawBody,headers:t.headers,timings:t.timings.phases,httpVersion:t.httpVersion,request:{method:t.request.options.method,url:`${t.request.options.url}`,headers:t.request.options.headers,body:$i(t.request.options.body)},contentType:Se(t.headers),meta:{ip:t.ip,redirectUrls:t.redirectUrls,size:(0,Os.default)(t.rawHeaders.map(r=>r.length).reduce((r,o)=>r+o,0)+t.rawBody.length)}};return delete t.headers[":status"],e.httpVersion&&e.httpVersion.startsWith("HTTP/")&&(e.httpVersion=e.httpVersion.slice("HTTP/".length)),e}function $i(t){if(c(t)||Buffer.isBuffer(t))return t}function Er(t){var r,o;let e=T(P({},((r=t.config)==null?void 0:r.request)||{}),{proxy:(o=t.config)==null?void 0:o.proxy});return Ls(e)}var O={showNote:async function(){throw new Error("Not Implemented")},showInputPrompt:async function(){throw new Error("Not Implemented")},showListPrompt:async function(){throw new Error("Not Implemented")}};var Qo={};ie(Qo,{HttpFileStore:()=>Jt,UserSessionStore:()=>Jo,cookieStore:()=>Ar,getEnviromentConfig:()=>ht,userSessionStore:()=>U});var $r=v(require("tough-cookie"));var Ts=class{constructor(){this.storeCache=[]}getCookieStoreId(e){var r,o;return`Cookies_${W(e.activeEnvironment)}_${((o=(r=e.rootDir)==null?void 0:r.toString)==null?void 0:o.call(r))||"none"}`}getCookieStoreEntry(e){let r=this.getCookieStoreId(e),o=this.storeCache.find(s=>s.id===r);return o||(o={id:r,memoryCookieStore:new $r.MemoryCookieStore},this.storeCache.push(o)),o}getCookies(e){let r=[],{memoryCookieStore:o}=this.getCookieStoreEntry(e);return o.synchronous&&o.getAllCookies((s,n)=>{s||r.push(...n)}),r}async reset(e){if(e){let r=this.getCookieStoreEntry(e);r.memoryCookieStore=new $r.MemoryCookieStore}else this.storeCache=[]}removeCookies(e,r){let{memoryCookieStore:o}=this.getCookieStoreEntry(e);for(let s of r)s.domain&&s.path&&o.removeCookie(s.domain,s.path,s.key,n=>{n&&m.error(n)})}},Ar=new Ts;var Oo={};ie(Oo,{AfterJavascriptHookInterceptor:()=>lo,BeforeJavascriptHookInterceptor:()=>ao,ParserId:()=>I,ParserRegex:()=>g,ProtoDefinitionCreationInterceptor:()=>ko,ProtoImportAction:()=>xo,closeRequestBody:()=>uo,closeResponseBody:()=>fo,initParseEndHook:()=>So,initParseHook:()=>Ho,injectNote:()=>Po,injectOnEveryRequestJavascript:()=>io,knownMetaData:()=>rn,parseComment:()=>Fr,parseComments:()=>Ut,parseEventSource:()=>to,parseGraphql:()=>ro,parseHttpFile:()=>oo,parseIntellijScript:()=>so,parseJavascript:()=>no,parseMQTTLine:()=>Co,parseMetaData:()=>eo,parseOutputRedirection:()=>ho,parseProtoImport:()=>vo,parseRequestBody:()=>po,parseRequestLine:()=>mo,parseResponse:()=>co,parseResponseRef:()=>go,parseVariable:()=>Ro,parseWebsocketLine:()=>wo});var g={auth:{aws:/^\s*(aws)\s+(?<accessKeyId>[^\s]*)\s+(?<secretAccessKey>[^\s]*)\s*(token:\s*(?<token>[^\s]*))?\s*(region:\s*(?<region>[^\s]*))?\s*(service:\s*(?<service>[^\s]*))?\s*$/iu,basic:/^\s*(basic)\s+(?<user>[^\s]*)\s+(?<password>([^\s]+.*))$/iu,basicColon:/^\s*(basic)\s+(?<user>.*):(?<password>.*)$/iu,clientCert:/^\s*(cert:\s*(?<cert>[^\s]*)\s*)?(key:\s*(?<key>[^\s]*)\s*)?(pfx:\s*(?<pfx>[^\s]*)\s*)?(passphrase:\s*(?<passphrase>[^\s]*)\s*)?\s*$/u,digest:/^\s*(digest)\s+(?<user>[^\s]*)\s+(?<password>([^\s]+.*))$/iu,oauth2:/^\s*(?<type>openid|oauth2)(\s+(?<flow>client(_credentials)?|(authorization_)?code|device(_code)?|password|implicit|hybrid))?(\s+(?<variablePrefix>[^\s]*))?\s*((token_exchange)\s+(?<tokenExchangePrefix>[^\s]*))?\s*$/iu},comment:{multilineEnd:/^\s*\*\/\s*$/u,multilineStart:/^\s*\/\*$/u,singleline:/^\s*\/\/\s*(?<comment>.*)\s*$/u},emptyLine:/^\s*$/u,gql:{fileImport:/^\s*gql(\s+(?<name>[^\s(]+))?\s+<\s+(?<fileName>.+)\s*$/u,fragment:/^\s*(fragment)\s+(?<name>[^\s(]+)\s+on\s+/u,query:/^\s*(query|mutation)(\s+(?<name>[^\s(]+))?/u},grpc:{proto:/^\s*proto\s+<\s+(?<fileName>.+)\s*$/u,grpcLine:/^\s*(GRPC|grpc)\s*(?<url>.+?)\s*$/u,grpcProtocol:/^\s*grpc:\/\/(?<url>.+?)\s*$/u,grpcUrl:/^\s*(grpc:\/\/)?(?<server>.+?)\/(?<service>[^/]+?)\/(?<method>[^/]+?)$/u,sslAuthorization:/^\s*(ssl)\s+(?<root>[^\s]*)\s+(?<cert>[^\s]*)\s+(?<key>[^\s]*)\s*$/iu},stream:{websocketLine:/^\s*(ws|wss|websocket)\s*(?<url>.+?)\s*$/ui,websocketProtocol:/^\s*ws(s)?:\/\/(?<url>.+?)\s*$/u,mqttLine:/^\s*(mqtt|mqtts)\s*(?<url>.+?)\s*$/ui,mqttProtocol:/^\s*mqtt(s)?:\/\/(?<url>.+?)\s*$/u,eventSourceLine:/^\s*(sse|eventsource)\s*(?<url>.+?)\s*$/ui},intellij:{import:/^\s*>\s+(?<fileName>[^\s{%}]+\s*)$/u,scriptEnd:/^\s*%\}\s*$/u,scriptSingleLine:/^\s*>\s+\{%\s*(?<script>.*)\s*%\}\s*$/u,scriptStart:/^\s*>\s+\{%\s*$/u},javascript:{scriptStart:/^\s*\{\{(@js\s+)?(?<modifier>\+|@)?(?<event>(request|streaming|response|after)?)?\s*$/u,scriptEnd:/^\s*\}\}\s*$/u,scriptSingleLine:/\{{2}(.+?)\}{2}/gu},meta:{all:/^\s*(#+|\/{2})/u,comment:/^\s*((#\s+)|(\/{2}))/u,delimiter:/^\s*#{3,}(?<title>.*)$/u,data:/^\s*(#+|\/{2,})\s+@(?<key>[^\s]*)(\s+)?"?(?<value>.*)?"?$/u,forOf:/^\s*for\s+(?<variable>.*)\s+of\s+(?<iterable>.*)\s*/u,for:/^\s*for\s*(?<counter>\d*)\s*$/u,while:/^\s*while\s*(?<expression>.*)\s*$/u,rateLimit:/^\s*(slot(:)?\s*(?<slot>[^\s]+))?\s*(minIdleTime(:)?\s*(?<minIdleTime>\d*))?\s*(max(:)?\s*(?<max>\d*)\s*expire(:)?\s*(?<expire>\d*))?\s*$/iu},request:{fileImport:/^<(?:(?<injectVariables>@)(?<encoding>\w+)?)?\s+(?<fileName>.+?)\s*$/u,header:/^\s*(?<key>[\w-]+)\s*:\s*(?<value>.*?),?\s*$/u,headersSpread:/^\s*\.{3}(?<variableName>[^\s]+),?\s*$/u,queryLine:/^\s*(\?|&)([^=\s]+)=(.*)$/u,requestLine:/^\s*(?<method>GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS|CONNECT|TRACE|PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|CHECKOUT|CHECKIN|REPORT|MERGE|MKACTIVITY|MKWORKSPACE|VERSION-CONTROL|BASELINE-CONTROL)\s*(?<url>.+?)(\s+HTTP\/(?<version>(\S+)))?$/u,urlLine:/^\s*(\/).*$/u},outputRedirection:/^\s*>>(?<force>!)?\s+(?<fileName>[^\s{%}]+\s*)$/u,responseLine:/^\s*HTTP\/(?<httpVersion>\S+)\s*(?<statusCode>[1-5][0-9][0-9])\s*(-)?\s*(?<statusMessage>.*)$/u,responseRef:/^\s*<>\s*(?<fileName>.+?)\s*$/u,variable:/^\s*@(?<key>[^\s=]*)\s*(?<operator>=\s*)"?(?<value>.*)"?\s*$/u};async function Fr(t,{httpRegion:e}){let r=t(!0),o=Ai(r);return o?(e.metaData.description||(e.metaData.description=o.comment),{nextParserLine:o.endLine,symbols:[{name:"comment",description:o.comment,kind:R.comment,startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset}]}):!1}function Ai(t){var r;let e=t.next();if(!e.done){let o=e.value.line,s=g.comment.singleline.exec(e.value.textLine);if((r=s==null?void 0:s.groups)==null?void 0:r.comment)return{startLine:o,endLine:o,endOffset:e.value.textLine.length,comment:s.groups.comment};if(g.comment.multilineStart.exec(e.value.textLine)){e=t.next();let i=[];for(;!e.done;){if(g.comment.multilineEnd.test(e.value.textLine))return{startLine:o,endLine:e.value.line,endOffset:e.value.textLine.length,comment:j(i)};i.push(e.value.textLine),e=t.next()}}}return!1}var Zr={};ie(Zr,{CookieJarAction:()=>qt,CreateRequestBodyInterceptor:()=>Bt,CreateRequestInterceptor:()=>Y,DefaultHeadersAction:()=>Tt,EventSourceClientAction:()=>Et,GqlAction:()=>It,GrpcClientAction:()=>$t,HttpClientAction:()=>At,ImportMetaAction:()=>Dt,IntellijAction:()=>jt,LoopMetaAction:()=>Ve,LoopMetaType:()=>me,MQTTClientAction:()=>Mt,RefMetaAction:()=>Vt,WebSocketClientAction:()=>Nt,attachDefaultHeaders:()=>jr,initOnRequestHook:()=>zr,initOnResponseHook:()=>Yr,requestVariableReplacer:()=>Qr,responseAsVariable:()=>Kr,testFactory:()=>dt});var Es=v(require("tough-cookie")),qt=class{constructor(){this.id=H.cookieJar}async process({request:e,httpRegion:r,httpFile:o,config:s}){if(K(e)&&!r.metaData.noCookieJar&&(s==null?void 0:s.cookieJarEnabled)){let n=new Es.CookieJar(Ar.getCookieStoreEntry(o).memoryCookieStore);if(e.headers&&e.url){let i=F(e.headers,"cookie");if(i){if(c(i))await n.setCookie(i,e.url);else if(Array.isArray(i))for(let a of i)await n.setCookie(a,e.url)}}e.cookieJar=n}return!0}};var Fi=require("lodash/cloneDeep"),Y=class{async beforeTrigger(e){var r,o;return e.arg.httpRegion.request&&e.index===0&&((o=(r=e.arg.progress)==null?void 0:r.report)==null||o.call(r,{message:"init request"}),e.arg.request=Fi(e.arg.httpRegion.request)),!0}};var Tt=class{constructor(e,r){this.data=e;this.setHeaders=r;this.id=H.defaultHeaders}async process(e){if(this.data&&e.variables){w(e,"set request headers");let r=await z(this.data,e);r&&this.setHeaders(Object.assign({},r),e)}return!0}};async function jr(t,e){var r;if(t&&((r=e.config)==null?void 0:r.defaultHeaders)){w(e,"set default request headers");let o=e.config.defaultHeaders;if(!t.headers)t.headers=P({},o);else for(let[s,n]of Object.entries(o))t.headers[s]||(t.headers[s]=n)}return t}var Is=v(require("eventsource"));var Et=class{constructor(){this.id=H.eventSourceClient}async process(e){let{request:r}=e;return or(r)?await ne(async()=>r.url?(w(e,`reqeust Server-Sent Events ${r.url}`),await this.requestEventSource(r,e)):!1,e):!1}async requestEventSource(e,r){var u,h;let{httpRegion:o}=r;if(!e.url)throw new Error("request url undefined");let s={};o.metaData.noRejectUnauthorized&&(s.rejectUnauthorized=!1);let n=He(e.headers,"event")||["data"],i=P({},e.headers);ir(i,"event"),s.headers=i;let a={request:e},l={},p=[],d;try{let x=new Is.default(e.url,s);r.progress&&(d=(h=(u=r.progress)==null?void 0:u.register)==null?void 0:h.call(u,()=>{x.close()})),x.addEventListener("open",y=>{m.debug("SSE open",y)});for(let y of n)x.addEventListener(y,b=>{m.debug(`SSE ${y}`,b),this.isMessageEvent(b)&&(l[b.type]||(l[b.type]=[]),l[b.type].push(b.data),r.httpRegion.metaData.noStreamingLog||(r.logStream?p.push(r.logStream("EventSource",b.type,b.data)):p.push(N(this.toHttpResponse(b,a),r))))});return x.addEventListener("error",y=>{m.debug("SSE error",y),l.error=[y]}),await r.httpRegion.hooks.onStreaming.trigger(r),await Promise.all(p),x.close(),this.toMergedHttpResponse(l,a)}finally{d&&d()}}isEventType(e){let r=e;return!!(r==null?void 0:r.type)}toMergedHttpResponse(e,r){let o=this.toHttpResponse(e,r);return e.error&&(o.statusCode=-1),o}toHttpResponse(e,r){let o=JSON.stringify(e,null,2),s=Buffer.from(o),n=T(P({headers:{},statusCode:0},r),{protocol:"SSE",body:o,prettyPrintBody:o,parsedBody:e,rawBody:s,contentType:{mimeType:"application/json",charset:"UTF-8",contentType:"application/json; charset=utf-8"}});return this.isEventType(e)&&e.type==="error"&&(n.statusCode=-1),n}isMessageEvent(e){let r=e;return!!r.type&&c(r.type)&&!!r.data}};var It=class{constructor(e){this.gqlData=e;this.id=H.gql;this.before=[H.httpClient]}async process(e){var r,o,s,n,i,a;if(((r=e.request)==null?void 0:r.body)&&((o=this.gqlData)==null?void 0:o.query)){w(e,"build GraphQL query");let l;if(c(this.gqlData.query))l=this.gqlData.query;else{let p=await this.gqlData.query(e);if(p)l=p;else{let d="query import not found";(n=(s=O).showWarnMessage)==null||n.call(s,d),m.warn(d)}}if(l){for(let[d,u]of Object.entries(this.gqlData.fragments))if(l.indexOf(`...${d}`)>=0){let h;if(c(u))h=u;else{let x=await u(e);if(x)h=x;else{let q=`query fragment ${d} not found`;(a=(i=O).showWarnMessage)==null||a.call(i,q),m.warn(q)}}h&&(l=j([l,h]))}let p={query:l};this.gqlData.operationName&&(p.operationName=this.gqlData.operationName),c(e.request.body)&&(p.variables=JSON.parse(e.request.body)),e.request.body=JSON.stringify(p)}}return!0}};var we=v(require("@grpc/grpc-js")),Be=v(require("stream")),$t=class{constructor(){this.id=H.grpcClient}async process(e){we.setLogger(m);let{request:r}=e,o=e.options.protoDefinitions;return nr(r)&&(r==null?void 0:r.url)&&o?await ne(async()=>{var s,n;if(r.url){w(e,`reqeust gRPC ${r.url}`);let i=this.getService(r.url,o);if(i.ServiceClass){let a=new i.ServiceClass(i.server,this.getChannelCredentials(r)),l=(n=(s=a[i.method])==null?void 0:s.bind)==null?void 0:n.call(s,a);if(l)return await this.requestGrpc(l,i.methodDefinition,r,e)}}return!1},e):!1}async requestGrpc(e,r,o,s){let n=this.getData(o),i=this.getMetaData(o),a=new Date().getTime();return await new Promise((l,p)=>{let d=[i],u,h={},x=[k=>k.on("metadata",C=>{h=C.getMap()}),k=>{s.progress&&(u=s.progress.register(()=>{k.destroy(new Error("Cancellation"))}))}],q=()=>({headers:h,request:o,timings:{total:new Date().getTime()-a}}),y=k=>{u&&u(),l(k)};(r==null?void 0:r.requestStream)?x.push(...this.getRequestStreamActions(n,s,p)):d.splice(0,0,n),(r==null?void 0:r.responseStream)?x.push(...this.getResponseStreamActions(r.path,y,q,s)):d.push((k,C)=>{y(this.toHttpResponse(k||C,q()))});let b=e(...d);x.forEach(k=>k(b))})}getRequestStreamActions(e,r,o){return[s=>{(e&&s instanceof Be.Writable||s instanceof Be.Duplex)&&s.write(e)},s=>{(s instanceof Be.Writable||s instanceof Be.Duplex)&&(Q({grpcStream:s},r),r.httpRegion.hooks.onStreaming.trigger(r).then(()=>s.end()).catch(n=>o(n)))}]}getResponseStreamActions(e,r,o,s){let n=[],i=[],a=!1,l=p=>async()=>{if(m.debug(`GRPC ${p}`),!a){a=!0,qe({grpcStream:!0},s),await Promise.all(n);let d=this.toMergedHttpResponse(i,o());r(d)}};return[p=>p.on("data",d=>{m.debug("GRPC data",d),i.push(d),s.httpRegion.metaData.noStreamingLog||(s.logStream?n.push(s.logStream("gRPC",e,d)):n.push(N(this.toHttpResponse(d,o()),s)))}),p=>p.on("error",d=>{m.debug("GRPC error",d),i.push(d)}),p=>p.on("end",l("end")),p=>p.on("close",l("close"))]}getData(e){return c(e.body)?JSON.parse(e.body):Buffer.isBuffer(e.body)?JSON.parse(e.body.toString("utf-8")):e.body}getChannelCredentials(e){if(e.headers){let r=F(e.headers,"channelcredentials")||F(e.headers,"authorization");if(r instanceof we.ChannelCredentials)return r}return we.credentials.createInsecure()}getMetaData(e){let r=new we.Metadata,o=["authorization","channelcredentials"];if(e.headers)for(let[s,n]of Object.entries(e.headers))o.indexOf(s.toLowerCase())<0&&(c(n)||Buffer.isBuffer(n))&&r.add(s,n);return r}getService(e,r){var s;let o=g.grpc.grpcUrl.exec(e);if(o&&((s=o.groups)==null?void 0:s.service)){let{server:n,service:i,method:a}=o.groups,l=this.flattenProtoDefintions(r),p=l[i];if(!p){let d=Object.keys(l).find(u=>u.indexOf(i)>=0);d&&(m.warn(`service ${i} not found. Similar service ${d} is used.`),p=l[d])}if(typeof p=="function"){let d=p.service[a]||Object.entries(p.service).filter(([u])=>u.toLowerCase()===a.toLowerCase()).map(([,u])=>u).pop();return{server:n,service:i,method:a,ServiceClass:p,methodDefinition:d}}throw m.error(`Service ${i} does not exist. Available Services`,...Object.keys(l)),new Error(`Service ${i} does not exist. Available Services: ${Object.keys(l).join(", ")}`)}else throw new Error(`Url ${e} does not match pattern <server>/<service>/<method>`)}flattenProtoDefintions(e){let r={};for(let o of Object.values(e))if(o.grpcObject){let s=this.getFlatGrpcObject(o.grpcObject);Object.assign(r,s)}return r}getFlatGrpcObject(e){return Object.entries(e).reduce((r,o)=>{if(typeof o[1]=="function")r[o[0]]=o[1];else if(this.isGrpcObject(o[1]))for(let[s,n]of Object.entries(this.getFlatGrpcObject(o[1])))r[`${o[0]}.${s}`]=n;return r},{})}isGrpcObject(e){let r=e;return r&&!r.format&&typeof e!="function"}toHttpResponse(e,r){let o=JSON.stringify(e,null,2),s=T(P({headers:{}},r),{statusCode:0,statusMessage:"OK",protocol:"GRPC",body:o,prettyPrintBody:o,parsedBody:e,rawBody:Buffer.from(o),contentType:{mimeType:"application/grpc+json",charset:"UTF-8",contentType:"application/grpc+json; charset=utf-8"}});return this.isGrpcError(e)&&(s.statusCode=e.code||-1,s.statusMessage=e.details),s}toMergedHttpResponse(e,r){let o=this.toHttpResponse(e,r),s=e.find(n=>this.isGrpcError(n));return this.isGrpcError(s)&&(o.statusCode=s.code||-1,o.statusMessage=s.details),o}isGrpcError(e){return e instanceof Error}};var At=class{constructor(){this.id=H.httpClient}async process(e){let{httpRegion:r,httpClient:o,request:s}=e;return K(s)?(s.proxy=r.metaData.proxy,r.metaData.noRedirect&&(s.followRedirect=!r.metaData.noRedirect),r.metaData.noRejectUnauthorized&&(s.rejectUnauthorized=!1),ne(async()=>await o(s,e),e)):!1}};var me;(function(o){o[o.for=0]="for",o[o.forOf=1]="forOf",o[o.while=2]="while"})(me||(me={}));var Ve=class{constructor(e){this.data=e;this.id=H.loop}async beforeLoop(e){var o,s;this.iteration=this.iterate(e.arg),this.name=e.arg.httpRegion.metaData.name,(s=(o=e.arg.progress)==null?void 0:o.report)==null||s.call(o,{message:"start loop"});let r=await this.iteration.next();return r.done?!1:(Object.assign(e.arg.variables,r.value.variables),!0)}async afterTrigger(e){var r,o;if(this.iteration&&e.index+1===e.length){let s=await this.iteration.next();s.done||((o=(r=e.arg.progress)==null?void 0:r.report)==null||o.call(r,{message:`${s.value.index} loop pass`}),Object.assign(e.arg.variables,s.value.variables),await N(e.arg.httpRegion.response,e.arg),e.arg.httpRegion=this.createHttpRegionClone(e.arg.httpRegion,s.value.index),e.index=-1)}else this.name&&e.arg.variables[this.name]&&(e.arg.variables[`${this.name}0`]=e.arg.variables[this.name]);return!0}async*iterate(e){switch(this.data.type){case 1:if(this.data.variable&&this.data.iterable){let r=await z(this.data.iterable,e),o;if(Array.isArray(r)&&(o=r),o){let s=0;for(let n of o){let i={$index:s};i[this.data.variable]=n,yield{index:s,variables:i},s++}}}break;case 0:if(this.data.counter)for(let r=0;r<this.data.counter;r++)yield{index:r,variables:{$index:r}};break;case 2:if(this.data.expression){let r=0;for(;await z(this.data.expression,e);)yield{index:r,variables:{$index:r}},r++}break;default:break}}createHttpRegionClone(e,r){return{metaData:T(P({},e.metaData),{name:this.name?`${this.name}${r}`:void 0}),request:e.request?P({},e.request):void 0,symbol:e.symbol,hooks:{execute:new Ie,onRequest:new be,onStreaming:new Ee,onResponse:new Re},variablesPerEnv:e.variablesPerEnv}}};var Bs=v(require("assert"));var Dr=v(require("chalk"));function dt({httpRegion:t,scriptConsole:e}){let r=function(s,n){var a,l;let i={message:s,result:!0};if(t.testResults||(t.testResults=[]),typeof n=="function")try{n()}catch(p){process.exitCode=20,i.result=!1,wr(p)?i.error=Cr(p):i.error={displayMessage:`${p}`,error:new Error(`${p}`)}}t.testResults.push(i),(l=e==null?void 0:e.logTest)==null||l.call(e,i.result,i.result?Dr.default`{green ${le.ok} ${i.message||"Test passed"}}`:Dr.default`{red ${le.error} ${i.message||"Test failed"} (${(a=i.error)==null?void 0:a.displayMessage})}`)};return r.status=o=>{if(t.response){let s=t.response;r(`response status equals to ${o}`,()=>lr(s,o))}},r.totalTime=o=>{if(t.response){let s=t.response;r(`total time exceeded ${o}`,()=>pr(s,o))}},r.header=(o,s)=>{if(t.response){let n=t.response;r(`response header equals ${s}`,()=>ur(n,o,s))}},r.headerContains=(o,s)=>{if(t.response){let n=t.response;r(`response header contains ${s}`,()=>dr(n,o,s))}},r.responseBody=o=>{if(t.response){let s=t.response;r(`response body equals ${o}`,()=>fr(s,o))}},r.hasResponseBody=()=>{if(t.response){let o=t.response;r("response body exists",()=>mr(o))}},r.hasNoResponseBody=()=>{if(t.response){let o=t.response;r("response body does not exists",()=>cr(o))}},r}var Ue={};ie(Ue,{VariableProviderType:()=>ce,initProvideEnvironmentsHook:()=>Bi,initProvideVariablesHook:()=>Mi,intellijVariableCache:()=>Ne,provideDotenvEnvironments:()=>Mr,provideDotenvVariables:()=>Br,provideIntellijEnvironments:()=>Vr,provideIntellijGlobalVariables:()=>_r,provideIntellijVariables:()=>Nr});var $s=v(require("dotenv"));var As=[".env"];async function Mr(t){var o;let e=[],r=process.env.HTTPYAC_ENV;if(r&&c(r)){let s=await D(r,t.httpFile.rootDir,!0);s&&e.push(...await f.readdir(s))}if(t.httpFile.rootDir&&e.push(...await f.readdir(t.httpFile.rootDir)),(o=t.config)==null?void 0:o.envDirName){let s=await D(t.config.envDirName,t.httpFile.rootDir,!0);s&&e.push(...await f.readdir(s));let n=await D(f.dirname(t.httpFile.fileName),t.httpFile.rootDir);n&&e.push(...await f.readdir(n))}return e.filter(s=>s.startsWith(".env")||s.endsWith(".env")).filter(s=>As.indexOf(s)<0).map(s=>s.startsWith(".env")?s.slice(5):s.slice(0,s.length-4))}async function Br(t,e){var a;let r=ji(t),o=[],s=process.env.HTTPYAC_ENV;if(s&&c(s)){let l=await D(s,e.httpFile.rootDir,!0);l&&o.push(...await Ft(r,l))}if(e.httpFile.rootDir&&o.push(...await Ft(r,e.httpFile.rootDir)),(a=e.config)==null?void 0:a.envDirName){let l=await D(e.config.envDirName,e.httpFile.rootDir,!0);l&&o.push(...await Ft(r,l))}let n=await D(f.dirname(e.httpFile.fileName),e.httpFile.rootDir);n&&o.push(...await Ft(r,n));let i=Object.assign({},...o);return Le(i)}function ji(t){let e=[...As];if(t)for(let r of t)e.push(`${r}.env`,`.env.${r}`);return e}async function Ft(t,e){let r=await f.readdir(e),o=t.filter(n=>r.indexOf(n)>=0),s=[];for(let n of o){let i=f.joinPath(e,n);try{let a=await f.readFile(i,"utf-8"),l=(0,$s.parse)(a);s.push(l)}catch{m.trace(`${f.toString(e)}/${n} not found`)}}return s}var Fs="$shared";async function js(t){var e;return((e=t.config)==null?void 0:e.environments)?Object.keys(t.config.environments).filter(r=>r!==Fs):[]}async function Ds(t,e){var o;let r=[];if((o=e.config)==null?void 0:o.environments){let s=e.config.environments;r.push(s[Fs]),t&&r.push(...t.map(n=>s[n]))}return Le(Object.assign({},...r))}var Di=["http-client.env.json","http-client.private.env.json"];async function Vr(t){return(await Ms(t)).reduce((r,o)=>{for(let[s]of Object.entries(o))r.push(s);return r},[])}async function Ms(t){var o;let e=[];if(t.httpFile.rootDir&&e.push(...await Ur(t.httpFile.rootDir)),(o=t.config)==null?void 0:o.envDirName){let s=await D(t.config.envDirName,t.httpFile.rootDir,!0);s&&e.push(...await Ur(s))}let r=await D(f.dirname(t.httpFile.fileName),t.httpFile.rootDir);return r&&e.push(...await Ur(r)),e}async function Nr(t,e){let r=await Ms(e),o=[];if(t)for(let s of t)o.push(...r.filter(n=>!!n[s]).map(n=>n[s]));return Le(Object.assign({},...o))}async function Ur(t){let e=[];for(let r of Di)try{let o=f.joinPath(t,r);if(await f.exists(o)){let s=await f.readFile(o,"utf-8");e.push(JSON.parse(s))}}catch{m.trace(`${f.toString(t)}/${r} not found`)}return e}var Ne={};async function _r(t){let e=W(t);return Ne[e]||(Ne[e]={}),Ne[e]}var ce;(function(i){i.config="config",i.dotenv="dotenv",i.httpFileImports="httpFileImports",i.httpFile="httpFile",i.intellij="intellij",i.intellijGlobal="intellijGlobal"})(ce||(ce={}));function Mi(){let t=new vt;return t.addHook(ce.config,Ds),t.addHook(ce.dotenv,Br),t.addHook(ce.intellij,Nr),t.addHook(ce.intellijGlobal,_r),t}function Bi(){let t=new xt;return t.addHook(ce.config,js),t.addHook(ce.dotenv,Mr),t.addHook(ce.intellij,Vr),t}var Gr=class{constructor(e,r){this.variables=e;this.env=r}get globalCache(){return Ne[W(this.env)]}set(e,r){this.globalCache[e]=r,this.variables[e]=r}get(e){return this.variables[e]}isEmpty(){return Object.entries(this.globalCache).length===0}clear(e){delete this.globalCache[e],delete this.variables[e]}clearAll(){for(let[e]of Object.entries(this.globalCache))delete this.globalCache[e],delete this.variables[e]}};var Wr=class{constructor(e){this.context=e;this.global=new Gr(e.variables,e.httpFile.activeEnvironment)}test(e,r){dt(this.context)(e,r)}assert(e,r){(0,Bs.ok)(e,r)}log(e){this.context.scriptConsole&&this.context.scriptConsole.info(e)}};var Jr=class{constructor(e){var r,o;this.body=e.parsedBody||e.body,this.status=e.statusCode,this.contentType={mimeType:((r=e.contentType)==null?void 0:r.mimeType)||"application/octet-stream",charset:((o=e.contentType)==null?void 0:o.charset)||"utf-8"},this.headers=new Vs(e.headers)}},Vs=class{constructor(e){this.headers=e}valueOf(e){if(this.headers){let r=this.headers[e];if(r&&c(r))return r}return null}valuesOf(e){if(this.headers){let r=this.headers[e];if(r&&Array.isArray(r))return r}return[]}};var jt=class{constructor(e){this.scriptData=e;this.id=H.intellij}async process(e){let r=Vi(e),o;if(this.isIntellijScriptData(this.scriptData)){let s=await this.loadScript(this.scriptData.fileName,e);if(!s)return!1;o={script:s,lineOffset:0}}else o=this.scriptData;return w(e,"execute intellij javascript"),await De(o.script,{fileName:e.httpFile.fileName,context:P({console:e.scriptConsole},r),lineOffset:o.lineOffset}),!0}async loadScript(e,r){var o,s;try{return await ye(e,r,n=>f.readFile(n,"utf-8"))}catch(n){return(s=(o=O).showErrorMessage)==null||s.call(o,`error loading script ${e}`),m.error(e,n),!1}}isIntellijScriptData(e){return!!e.fileName}};function Vi(t){let e;return t.httpRegion.response&&(e=new Jr(t.httpRegion.response)),{client:new Wr(t),response:e}}var Dt=class{constructor(e,r){this.fileName=e;this.httpFileStore=r;this.id=H.import}async process(e){let r=await D(this.fileName,e.httpFile.fileName);if(r){m.trace(`parse imported file ${r}`);let o=await f.readFile(r,"utf-8"),s=await this.httpFileStore.getOrCreate(r,()=>Promise.resolve(o),0,{workingDir:e.httpFile.rootDir,config:e.config,activeEnvironment:e.httpFile.activeEnvironment});e.options.httpFiles?e.options.httpFiles.push(s):e.options.httpFiles=[s];let n=T(P({},e),{httpFile:s});return m.trace(`execute global scripts for import ${r}`),await Me(n)}return!1}};async function Qr(t,e){if(w(e,"replace variables in request"),t.url){let r=await de(t.url,V.url,e)||t.url;if(r===S)return S;c(r)&&(t.url=r)}return await Ni(t,e)===!1?S:await Ui(t,e)===!1?S:t}async function Ni(t,e){if(t.body){if(c(t.body)){let r=await de(t.body,V.body,e);if(r===S)return!1;(c(r)||Buffer.isBuffer(r))&&(t.body=r)}else if(Array.isArray(t.body)){let r=[];for(let o of t.body)if(c(o)){let s=await de(o,V.body,e);if(s===S)return!1;c(s)&&r.push(s)}else r.push(o);t.body=r}}return!0}async function Ui(t,e){if(t.headers)for(let[r,o]of Object.entries(t.headers))if(Array.isArray(o)){let s=[];for(let n of o){let i=await de(n,r,e);if(i===S)return!1;s.push(i)}t.headers[r]=s}else{let s=await de(o,r,e);if(s===S)return!1;t.headers[r]=s}return!0}var Ns=v(require("encodeurl"));async function Us(t){return t.body&&(c(t.body)?tt(t.contentType)&&(t.body=(0,Ns.default)(t.body)):Array.isArray(t.body)&&t.body.some(e=>typeof e=="function")&&t.body.every(e=>["function","string"].indexOf(typeof e)>=0)&&(t.body=await _i(t.body))),t}async function _i(t){let e=[];for(let r of t)c(r)?e.push(Buffer.from(r)):e.push(await r());return Buffer.concat(e)}async function Kr(t,e){let r=t.parsedBody||t.body;return e.variables.response=t,(e.httpRegion.metaData.name||e.httpRegion.metaData.jwt)&&(Wi(r,e),Gi(r,e)),t}function Gi(t,e){var o,s;let{httpRegion:r}=e;if(r.metaData.name){let n=r.metaData.name.trim().replace(/\s/u,"_").replace(/-./gu,i=>i[1].toUpperCase());if(nt(n))Q({[n]:t},e);else{let i=`Javascript Keyword ${n} not allowed as name`;(s=(o=O).showWarnMessage)==null||s.call(o,i),m.warn(i)}}}function Wi(t,{httpRegion:e}){if(e.metaData.jwt&&e.response&&t&&typeof t=="object"){let r=Object.entries(t),o=r;if(c(e.metaData.jwt)){let s=e.metaData.jwt;o=r.filter(([n])=>s.indexOf(n)>=0)}for(let[s,n]of o){let i=Ji(n);i&&r.push([`${s}_parsed`,i])}e.response.parsedBody=Object.fromEntries(r),e.response.prettyPrintBody=e.response.body=JSON.stringify(e.response.parsedBody,null,2)}}function Ji(t){if(c(t))try{return Oe(t)}catch(e){m.error(e)}return null}function zr(){let t=new be;return t.addHook("attachDefaultHeaders",jr),t.addHook("requestVariableReplacer",Qr),t.addHook("transformRequestBody",Us),t}function Yr(){let t=new Re;return t.addHook("addAdditionalBody",rt),t.addHook("responseAsVariable",Kr),t}var _s=v(require("mqtt")),Mt=class{constructor(){this.id=H.websocketClient}async process(e){let{request:r}=e;return sr(r)?await ne(async()=>r.url?(w(e,`request MQTT ${r.url}`),await this.requestMQTT(r,e)):!1,e):!1}async requestMQTT(e,r){let{httpRegion:o}=r;return await new Promise((s,n)=>{var b,k;if(!e.url){n(new Error("request url undefined"));return}let i=P({clientId:`httpyac_${Math.random().toString(16).slice(2,8)}`,username:F(e.headers,"username"),password:F(e.headers,"password"),keepalive:zt(F(e.headers,"keepalive")),clean:!!F(e.headers,"clean")},e.options);o.metaData.noRejectUnauthorized&&(i.rejectUnauthorized=!1);let a={request:e},l=[],p=[],d;r.progress&&(d=(k=(b=r.progress)==null?void 0:b.register)==null?void 0:k.call(b,()=>{u.end(!0,void 0,C=>C&&m.error("error on close",C))}));let u=(0,_s.connect)(e.url,i),h={mqttClient:u};u.on("connect",C=>{m.debug("MQTT connect",C),a.protocol=C.protocolId||"MQTT",a.headers=C.properties,C.protocolVersion&&(a.httpVersion=`${C.protocolVersion}`)}),u.on("reconnect",()=>m.debug("MQTT reconnect")),u.on("message",(C,$,M)=>{m.debug("MQTT message",$,M),l.push({topic:C,message:$.toString("utf-8"),date:new Date}),r.httpRegion.metaData.noStreamingLog||r.logStream&&p.push(r.logStream("MQTT",C,$))}),u.on("packetsend",C=>m.debug("MQTT packetsend",C)),u.on("packetreceive",C=>m.debug("MQTT packetreceive",C)),u.on("disconnect",C=>m.debug("MQTT disconnect",C)),u.on("close",()=>m.debug("MQTT close")),u.on("offline",()=>m.debug("MQTT offline")),u.on("error",C=>{m.debug("MQTT error",C),l.push(C)}),u.on("end",async()=>{m.debug("MQTT end"),d&&d(),qe(h,r),await Promise.all(p),s(this.toMergedHttpResponse(l,a))});let x=He(e.headers,"subscribe");x&&this.subscribeToTopics(u,x,this.toQoS(F(e.headers,"qos")));let q=He(e.headers,"publish");q&&this.publishToTopics(u,q,e);let y=He(e.headers,"topic");y&&(this.subscribeToTopics(u,y,this.toQoS(F(e.headers,"qos"))),this.publishToTopics(u,y,e)),Q(h,r),r.httpRegion.hooks.onStreaming.trigger(r).then(()=>u.end()).catch(C=>n(C))})}subscribeToTopics(e,r,o){for(let s of r)e.subscribe(s,{qos:o})}publishToTopics(e,r,o){if(o.body)for(let s of r)e.publish(s,o.body,{qos:this.toQoS(F(o.headers,"qos")),retain:!!F(o.headers,"retain")},n=>n&&m.error("publish error",n))}toQoS(e){switch(e){case"2":return 2;case"1":return 1;default:return 0}}toMergedHttpResponse(e,r){let o=JSON.stringify(e,null,2),s=Buffer.isBuffer(e)?e:Buffer.from(o),n=T(P({statusCode:0,protocol:"MQTT",contentType:{mimeType:"application/json",charset:"UTF-8",contentType:"application/json; charset=utf-8"},headers:{}},r),{body:o,rawBody:s}),i=e.find(a=>this.isMQTTError(a));return i&&this.isMQTTError(i)&&(n.statusCode=i.errno||-1,n.statusMessage=i.code),n}isMQTTError(e){return e instanceof Error}};var Xr=v(require("os")),Bt=class{constructor(e){this.rawBody=e}async beforeTrigger(e){var r,o;if(e.arg.request&&e.index===0){let s=e.arg.request.contentType,n=await this.normalizeBody(this.rawBody,e.arg);if(n.length>0)if((o=(r=e.arg.progress)==null?void 0:r.report)==null||o.call(r,{message:"init request body"}),tt(s))e.arg.request.body=this.formUrlEncodedJoin(n);else{n.every(p=>c(p))&&tr(s)&&n.push("");let i=[],a=[],l=er(s)?`\r
`:Xr.EOL;for(let p of n)c(p)?a.push(p):(a.length>0&&(a.push(l),i.push(a.join(l)),a.length=0),i.push(p),a.push(""));a.length>0&&i.length===0?e.arg.request.body=a.join(l):(a.length>0&&i.push(a.join(l)),e.arg.request.body=i)}}return!0}async normalizeBody(e,r){let o=[],s=n=>{var i;if(r.httpRegion.metaData.injectVariables)return!0;if((i=r.config)==null?void 0:i.requestBodyInjectVariablesExtensions){let a=gr(n);if(a)return r.config.requestBodyInjectVariablesExtensions.indexOf(a)>=0}return!1};for(let n of e)if(c(n))o.push(n);else{let i=await ye(n.fileName,r,async a=>s(n.fileName)||n.injectVariables?await f.readFile(a,n.encoding):()=>f.readBuffer(a));i&&o.push(i)}return o}formUrlEncodedJoin(e){let r=e.reduce((o,s,n)=>{let i=o;return c(s)&&(i+=`${n===0||s.startsWith("&")?"":Xr.EOL}${s}`),i},"");return c(r)?r:""}};var Vt=class{constructor(e){this.data=e;this.id=H.ref}async process(e){w(e,`load reference ${this.data.name}`);for(let r of e.httpFile.httpRegions)if(r.metaData.name===this.data.name&&!r.metaData.disabled&&r!==e.httpRegion){let o=W(e.httpFile.activeEnvironment);if(m.trace("import variables",r.variablesPerEnv[o]),Object.assign(e.variables,r.variablesPerEnv[o]),this.data.force||!e.variables[this.data.name]){let s=T(P({},e),{httpRegion:r});await ke(s)}return!0}if(e.options.httpFiles)for(let r of e.options.httpFiles){let o=T(P({},e),{options:P({},e.options),httpFile:r});delete o.options.httpFiles,await this.process(o)}return!0}};var Gs=v(require("ws"));var Qi=1e3,Ki=1001,Nt=class{constructor(){this.id=H.websocketClient}async process(e){let{request:r}=e;return rr(r)?await ne(async()=>r.url?(w(e,`reqeust websocket ${r.url}`),await this.requestWebsocket(r,e)):!1,e):!1}async requestWebsocket(e,r){let{httpRegion:o}=r,s=new Date().getTime();return await new Promise((n,i)=>{var b,k;if(!e.url){i(new Error("request url undefined"));return}let a=Object.assign({},e.options);o.metaData.noRedirect&&(a.followRedirects=!o.metaData.noRedirect),o.metaData.noRejectUnauthorized&&(a.rejectUnauthorized=!1),a.headers=e.headers;let l={request:e},p=[],d=[],u=()=>(l.timings={total:new Date().getTime()-s},l),h=new Gs.default(e.url,a),x={websocketClient:h},q;r.progress&&(q=(k=(b=r.progress)==null?void 0:b.register)==null?void 0:k.call(b,()=>{h.close(Ki,"CLOSE_GOING_AWAY")})),h.on("open",()=>{m.debug("WebSocket open"),e.body&&h.send(e.body,C=>m.error(C)),Q(x,r),r.variables.websocketClient=h,r.httpRegion.hooks.onStreaming.trigger(r).then(()=>h.close(Qi,"CLOSE_NORMAL")).catch(C=>i(C))}),h.on("upgrade",C=>{m.debug("WebSocket upgrade",C),l.headers=C.headers,l.statusCode=C.statusCode,l.statusMessage=C.statusMessage,l.httpVersion=C.httpVersion});let y=C=>$=>{let M=this.toStringBody($);m.debug(`WebSocket ${C}`,M),p.push({type:C,body:M}),r.httpRegion.metaData.noStreamingLog||(r.logStream?d.push(r.logStream("WebSocket",C,M)):d.push(N(this.toHttpResponse(M,u()),r)))};h.on("ping",y("ping")),h.on("pong",y("pong")),h.on("message",y("message")),h.on("error",C=>{m.debug("WebSocket error",C),p.push(C)}),h.on("close",async(C,$)=>{m.debug("WebSocket close",C,$),q&&q(),qe(x,r),await Promise.all(d),n(this.toMergedHttpResponse(C,$,p,u()))})})}toMergedHttpResponse(e,r,o,s){let n=this.toHttpResponse(o,s);return n.statusCode=e,n.statusMessage=Buffer.isBuffer(r)?r.toString("utf-8"):r,n}toStringBody(e){if(Buffer.isBuffer(e))return e.toString("utf-8");let r=e;return Array.isArray(e)&&e.every(o=>Buffer.isBuffer(o))&&(r=e.map(o=>Buffer.isBuffer(o)&&o.toString("utf8"))),JSON.stringify(r,null,2)}toHttpResponse(e,r){let o=c(e)?e:JSON.stringify(e,null,2),s=Buffer.from(o),n=T(P({headers:{},statusCode:200},r),{protocol:"WebSocket",body:o,prettyPrintBody:o,parsedBody:e,rawBody:s,contentType:{mimeType:"application/json",charset:"UTF-8",contentType:"application/json; charset=utf-8"}});return this.isWebsocketError(e)&&(n.statusCode=-1,n.statusMessage=e.code),n}isWebsocketError(e){return e instanceof Error}};function Ws(t,e,r){return r.httpRegion.metaData=Object.assign(r.httpRegion.metaData||{},{[t]:e||!0}),!0}function Js(t,e,r){return t==="import"&&e?(r.httpRegion.hooks.execute.addObjHook(o=>o.process,new Dt(e,r.httpFileStore)),!0):!1}function Qs(t,e,r){return["ref","forceRef"].indexOf(t)>=0&&e?(r.httpRegion.hooks.execute.addObjHook(o=>o.process,new Vt({name:e,force:t==="forceRef"})),!0):!1}function Ks(t,e,r){var o,s,n,i;if(t==="loop"&&e){let a=g.meta.forOf.exec(e);if(((o=a==null?void 0:a.groups)==null?void 0:o.iterable)&&((s=a==null?void 0:a.groups)==null?void 0:s.variable))return r.httpRegion.hooks.execute.addInterceptor(new Ve({type:me.forOf,variable:a.groups.variable,iterable:a.groups.iterable})),!0;let l=g.meta.for.exec(e);if((n=l==null?void 0:l.groups)==null?void 0:n.counter)return r.httpRegion.hooks.execute.addInterceptor(new Ve({type:me.for,counter:Number.parseInt(l.groups.counter,10)})),!0;let p=g.meta.while.exec(e);if((i=p==null?void 0:p.groups)==null?void 0:i.expression)return r.httpRegion.hooks.execute.addInterceptor(new Ve({type:me.while,expression:p.groups.expression})),!0}return!1}function zs(t,e,r){return t==="keepStreaming"?(r.httpRegion.hooks.onStreaming.addHook("keepStreaming",async o=>{if(o.request){let s={id:Ys(o.request),type:"Stream",title:`${o.request.method} ${o.request.url}`,description:"Pending Stream",details:o.request.headers||{}};w(o,"stream until manual cancellation"),await new Promise(n=>{U.setUserSession(s),s.delete=()=>n(!0)})}}),r.httpRegion.hooks.onResponse.addHook("keepStreaming",(o,s)=>{s.request&&U.removeUserSession(Ys(s.request))}),!0):!1}function Ys(t){return`${t.method}_${t.url}_${Object.values(t.headers||{}).join("_")}`}function Xs(t,e,{httpRegion:r}){if(t==="ratelimit"&&e){let o=g.meta.rateLimit.exec(e);if(o==null?void 0:o.groups){let s=o.groups.slot||"rateLimit",n=o.groups.minIdleTime||"0",i=o.groups.max||"0",a=o.groups.expire||"0";r.hooks.execute.addHook("rateLimit",async l=>{let p=Xi(s,Number.parseInt(n,10),Number.parseInt(i,10),Number.parseInt(a,10));return p.requests.push(await zi(p,l)),!0})}}return!1}async function zi(t,e){for(;t.requests.length>0;){let r=new Date;if(Zi(t.requests,r,t.expire),t.max>0&&t.requests.length>=t.max){let o=t.requests[0],s=t.expire+o.getTime()-r.getTime();s>0&&(w(e,`rate limit max reached. wait for ${s}`),m.debug(`rate limit max reached. wait for ${s} (slot ${t.slot})`),await ue(s),m.trace("rate limit max waited"));continue}if(t.requests.length>0){let o=t.requests[t.requests.length-1];if(o&&t.minIdleTime>0){let s=o.getTime()+t.minIdleTime-r.getTime();if(s>0){w(e,`rate limit minIdleTime, wait for ${s}`),m.debug(`rate limit minIdleTime, wait for ${s} (slot ${t.slot})`),await ue(s),m.trace("rate limit minIdleTime waited");continue}}}return r}return new Date}function Yi(t){let e=t;return!!(e==null?void 0:e.requests)&&e.type==="RateLimit"}function Xi(t,e,r,o){let s=`ratelimit_${t}`,n=U.getUserSession(s);if(Yi(n))return n.max=r,n.minIdleTime=e,n.expire=o,n;let i=[];e>0&&i.push(`minIdleTime ${e}ms`),o>0&&i.push(`max ${r} with expire ${o}ms`);let a={id:s,type:"RateLimit",title:`rate limit slot ${t}`,details:{slot:t,minIdleTime:e,max:r,expire:o},description:i.join(", "),slot:t,minIdleTime:e,max:r,expire:o,requests:[]};return U.setUserSession(a),a}function Zi(t,e,r){if(r>0){let o=0;for(let s of t)if(e.getTime()-s.getTime()>=r)o++;else break;t.splice(0,o)}else t.splice(0,t.length-1)}function Zs(t,e,r){return t==="responseRef"&&e&&(r.httpRegion.responseRefs||(r.httpRegion.responseRefs=[]),r.httpRegion.responseRefs.push(e)),!1}function en(t,e,r){return t==="sleep"&&e?(r.httpRegion.hooks.execute.addHook("sleep",async o=>{let s=await z(e,o);return Number.isSafeInteger(s)&&await ue(s),!0}),!0):!1}function tn(t,e,r){if(t==="verbose"||t==="debug"){let o=t==="debug"?E.debug:E.trace;return m.options.level=o,r.httpRegion.hooks.execute.addInterceptor({async beforeLoop(){return m.options.level=o,!0}}),!0}return!1}async function eo(t,e){var i,a;let r=t(),{httpRegion:o,data:s}=e;s.metaTitle&&(o.metaData.title=s.metaTitle.trim(),o.metaData.name||(o.metaData.name=s.metaTitle.trim()),delete s.metaTitle);let n=r.next();if(!n.done){let l=n.value.textLine;if(g.meta.all.test(l)){if(ea(e)&&l.trim()!=="###")return m.debug("request with markdown only supports delimiter after request line"),!1;let p={nextParserLine:n.value.line,symbols:[]},d=g.meta.delimiter.exec(l);if(d)p.endRegionLine=n.value.line-1,p.symbols.push({name:"separator",description:((i=d.groups)==null?void 0:i.title)||"-",kind:R.metaData,startLine:n.value.line,startOffset:0,endLine:n.value.line,endOffset:l.length}),s.metaTitle=(a=d.groups)==null?void 0:a.title;else{let u=Ut(n.value,e,g.meta.all);u&&(p.symbols=u.symbols)}return p}}return!1}function Ut(t,e,r){var o;if(r.test(t.textLine)){let s={symbols:[{name:"comment",description:t.textLine,kind:R.metaData,startLine:t.line,startOffset:0,endLine:t.line,endOffset:t.textLine.length}]},n=g.meta.data.exec(t.textLine);if(n&&n.groups&&n.groups.key){let i=n.groups.key.replace(/-./gu,l=>l[1].toUpperCase());s.symbols[0].children=[{name:i,description:n.groups.value||"-",kind:R.metaData,startLine:t.line,startOffset:0,endLine:t.line,endOffset:t.textLine.length,children:[{name:i,description:((o=rn.find(l=>l.name===i))==null?void 0:o.description)||"key of meta data",kind:R.key,startLine:t.line,startOffset:t.textLine.indexOf(n.groups.key),endLine:t.line,endOffset:t.textLine.indexOf(n.groups.key)+n.groups.key.length}]}],n.groups.value&&s.symbols[0].children.push({name:n.groups.value,description:"value of meta data",kind:R.value,startLine:t.line,startOffset:t.textLine.indexOf(n.groups.value),endLine:t.line,endOffset:t.textLine.indexOf(n.groups.value)+n.groups.value.length});let a=[Js,zs,Ks,Xs,Qs,Zs,en,tn];a.push(Ws);for(let l of a)if(l(i,n.groups.value,e))break}return s}return!1}function ea(t){var e;if((e=t.httpRegion.request)==null?void 0:e.headers){let r=Se(t.httpRegion.request.headers);if(et(r))return!0}return!1}var rn=[{name:"name",description:"responses of a requests with a name are automatically added as variables and can be reused by other requests",completions:["${1}"]},{name:"debug",description:"enable debug log level"},{name:"description",description:"additional description of region",completions:["${1}"]},{name:"disabled",description:"requests can be disabled"},{name:"extension",description:"extension of file for save or openWith.",completions:["${1}"]},{name:"forceRef",description:"When the request is called, it is ensured that the referenced request is always called beforehand",completions:["${1}"]},{name:"import",description:"reference Requests from other files.",completions:["${1}"]},{name:"injectVariables",description:"Inject Variables in request body (needed because of compatibility with Intellij)."},{name:"jwt",description:"supports auto decode of jwt token."},{name:"language",description:"language id of the response view",completions:["${1}"]},{name:"loop",description:"allows multiple Invocations of a Request with different parameters.",completions:["for ${1} of ${2}","for ${1}","while ${1}"]},{name:"keepStreaming",description:"keep streaming until the user session is ended manually"},{name:"noLog",description:"prevent logging of request data in output console"},{name:"noCookieJar",description:"cookieJar support is disabled for this request"},{name:"noClientCert",description:"SSL client certificate is not send for this request"},{name:"noRejectUnauthorized",description:"all invalid SSL certificates will be ignored and no error will be thrown."},{name:"noResponseView",description:"prevent output in editor document."},{name:"noStreamingLog",description:"prevent logging of streaming request data in output console"},{name:"note",description:"shows a confirmation dialog before sending request",completions:["${1}"]},{name:"openWith",description:"viewType of custom editor to preview files",completions:["${1}"]},{name:"ref",description:"When the request is called, it is ensured that the referenced request is called beforehand",completions:["${1}"]},{name:"ratelimit",description:"allows throttling requests",completions:["minIdleTime ${1}","max ${1} expire ${2}","minIdleTime ${1} max ${2} expire ${3}"]},{name:"save",description:"If specified, the response will not be displayed but saved directly."},{name:"sleep",description:"wait specified millisecondes, before next step.",completions:["${1}"]},{name:"title",description:"additional title of region",completions:["${1}"]},{name:"verbose",description:"enable trace log level"}];function X(t,e,r){let o={parseResults:[]},s=t.next();for(;!s.done;){let n=!1;for(let i of e){let a=i(s.value,r);if(a){o.parseResults.push(a),n=!0;break}}if(!n)break;o.nextLine=s.value.line,s=t.next()}return o}function Z(t){return function(r){var s,n;let o=g.request.header.exec(r.textLine);if(((s=o==null?void 0:o.groups)==null?void 0:s.key)&&((n=o==null?void 0:o.groups)==null?void 0:n.value)){let i=o.groups.key,a=o.groups.value,l=t[i];return l?Array.isArray(l)?l.push(a):t[i]=[l,a]:t[i]=a,{symbols:[{name:i,description:a,kind:R.requestHeader,startLine:r.line,startOffset:r.textLine.indexOf(i),endLine:r.line,endOffset:r.textLine.length,children:[{name:i,description:"request header key",kind:R.key,startLine:r.line,startOffset:r.textLine.indexOf(i),endLine:r.line,endOffset:r.textLine.indexOf(i)+i.length},{name:a,description:"request header value",kind:R.value,startLine:r.line,startOffset:r.textLine.indexOf(a),endLine:r.line,endOffset:r.textLine.indexOf(a)+a.length}]}]}}return!1}}function ee(t){return function(r,o){var n;let s=g.request.headersSpread.exec(r.textLine);if((n=s==null?void 0:s.groups)==null?void 0:n.variableName){o.httpRegion.hooks.execute.addObjHook(a=>a.process,new Tt(s.groups.variableName,t));let i=r.textLine.trim();return{symbols:[{name:i,description:"header variable",kind:R.requestHeader,startLine:r.line,startOffset:r.textLine.indexOf(i),endOffset:r.textLine.length,endLine:r.line}]}}return!1}}function fe(t){return function(r){if(g.request.urlLine.test(r.textLine)){let o=r.textLine.trim();return t(o),{symbols:[{name:o,description:"urlpart",kind:R.url,startLine:r.line,startOffset:r.textLine.indexOf(o),endOffset:r.textLine.length,endLine:r.line}]}}return!1}}function on(t){return function(r){if(g.request.queryLine.test(r.textLine)){let o=r.textLine.trim();return t(o),{symbols:[{name:o,description:"query",kind:R.url,startLine:r.line,startOffset:r.textLine.indexOf(o),endOffset:r.textLine.length,endLine:r.line}]}}return!1}}function te(t,e){return Ut(t,e,g.meta.comment)}async function to(t,e){var s,n;let r=t(),o=r.next();if(!o.done&&ra(o.value.textLine)){if(e.httpRegion.request)return{endRegionLine:o.value.line-1,nextParserLine:o.value.line-1,symbols:[]};let i=ta(o.value.textLine,o.value.line);if(!i)return!1;e.httpRegion.request=i.request;let a={name:o.value.textLine,description:"websocket request-line",kind:R.requestLine,startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[i.symbol]},l={nextParserLine:o.value.line,symbols:[a]},p={};i.request.headers=p;let d=X(r,[te,Z(p),ee((u,h)=>{var x;return Object.assign((x=h.request)==null?void 0:x.headers,u)}),fe(u=>i.request.url+=u)],e);if(d){l.nextParserLine=d.nextLine||l.nextParserLine;for(let u of d.parseResults)(n=(s=l.symbols)==null?void 0:s.push)==null||n.call(s,...u.symbols)}return e.httpRegion.hooks.execute.addObjHook(u=>u.process,new Et),e.httpRegion.hooks.execute.addInterceptor(new Y),l}return!1}function ta(t,e){let r=g.stream.eventSourceLine.exec(t);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,method:"SSE"},symbol:{name:r.groups.url,description:"EventSource url",kind:R.url,startLine:e,startOffset:0,endLine:e,endOffset:t.length}}}function ra(t){var e,r;return G(t)?!1:!!((r=(e=g.stream.eventSourceLine.exec(t))==null?void 0:e.groups)==null?void 0:r.url)}async function ro(t,e){let r=t();if(e.httpRegion.metaData.noGqlParsing)return!1;let o=await sa(r);if(o){let s={fragments:oa(e)};return e.httpRegion.request?(s.query=o.gql,o.name&&(s.operationName=o.name,e.httpRegion.metaData.name||(e.httpRegion.metaData.name=o.name)),e.httpRegion.hooks.execute.addObjHook(n=>n.process,new It(s))):o.name&&(s.fragments[o.name]=o.gql),{nextParserLine:o.endLine,symbols:[{name:"gql",description:"gql",kind:R.gql,startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset}]}}return!1}function oa(t){let e=t.data.gql;return e||(e={},t.data.gql=e),e}async function sa(t){var r,o,s;let e=t.next();if(!e.done){let n=e.value.line,i=g.gql.fileImport.exec(e.value.textLine);if(i&&((r=i.groups)==null?void 0:r.fileName)){let p=i.groups.fileName;return{startLine:n,endLine:n,endOffset:e.value.textLine.length,name:i.groups.name||i.groups.fileName,gql:d=>ye(p,d,u=>f.readFile(u,"utf-8"))}}let a=g.gql.query.exec(e.value.textLine);if(a)return sn(e.value,t,(o=a.groups)==null?void 0:o.name);let l=g.gql.fragment.exec(e.value.textLine);if(l)return sn(e.value,t,(s=l.groups)==null?void 0:s.name)}return!1}function sn(t,e,r){let o=t.line,s=e.next(),n=[t.textLine];for(;!s.done;){if(g.emptyLine.test(s.value.textLine))return{name:r,startLine:o,endLine:s.value.line,endOffset:s.value.textLine.length,gql:j(n)};n.push(s.value.textLine),s=e.next()}return!1}async function oo(t,e,r){let o=xe(e),s={lines:o,httpFile:t,httpRegion:ln(0),data:{},httpFileStore:r};for(let n=0;n<o.length;n++){let i=await t.hooks.parse.trigger(ia(n,o),s);i&&i!==S&&(i.endRegionLine!==void 0&&i.endRegionLine>=0&&(s.httpRegion.symbol.endLine=i.endRegionLine,s.httpRegion.symbol.endOffset=o[i.endRegionLine].length,await nn(s),s.httpRegion=ln(i.nextParserLine+1)),i.symbols&&(s.httpRegion.symbol.children?s.httpRegion.symbol.children.push(...i.symbols):s.httpRegion.symbol.children=i.symbols),n=i.nextParserLine)}return await nn(s),s.httpRegion.symbol.endLine=o.length-1,s.httpRegion.symbol.endOffset=o[o.length-1].length,na(t.httpRegions,o),t}async function nn(t){await t.httpFile.hooks.parseEndRegion.trigger(t);let{httpRegion:e}=t;t.httpRegion.symbol.name=at(e),t.httpRegion.symbol.description=Pr(e),t.httpFile.httpRegions.push(t.httpRegion)}function na(t,e){for(let r of t)an(r.symbol,e)}function an(t,e){t.source=j(e.slice(t.startLine,t.endLine+1));let r=t.endOffset-e[t.endLine].length;if(r>=0&&(r=void 0),t.source=t.source.slice(t.startOffset,r),t.children)for(let o of t.children)an(o,e)}function ln(t){return{metaData:{},symbol:{name:"-",description:"-",kind:R.request,startLine:t,startOffset:0,endLine:t,endOffset:0},hooks:{execute:new Ie,onRequest:new be,onStreaming:new Ee,onResponse:new Re},variablesPerEnv:{}}}function ia(t,e){return function*(o){for(let s=t;s<e.length;s++){let n=e[s];if(yield{textLine:n,line:s},!o&&g.meta.delimiter.test(n))break}}}async function so(t,{httpRegion:e}){let r=t();if(e.request){let o=aa(r);if(o)return e.hooks.execute.addObjHook(s=>s.process,new jt(o.data)),{nextParserLine:o.endLine,symbols:[{name:"Intellij Script",description:"Intellij Script",kind:R.script,startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset}]}}return!1}function aa(t){var r,o;let e=t.next();if(!e.done){let s=e.value.line,n=g.intellij.import.exec(e.value.textLine);if((r=n==null?void 0:n.groups)==null?void 0:r.fileName)return{startLine:s,endLine:s,endOffset:e.value.textLine.length,data:{fileName:n.groups.fileName}};let i=g.intellij.scriptSingleLine.exec(e.value.textLine);if((o=i==null?void 0:i.groups)==null?void 0:o.script)return{startLine:s,endLine:s,endOffset:e.value.textLine.length,data:{script:i.groups.script,lineOffset:s}};if(g.intellij.scriptStart.exec(e.value.textLine)){e=t.next();let l=[];for(;!e.done;){if(g.intellij.scriptEnd.test(e.value.textLine))return{startLine:s,endLine:e.value.line,endOffset:e.value.textLine.length,data:{script:j(l),lineOffset:s}};l.push(e.value.textLine),e=t.next()}}}return!1}var la=v(require("@grpc/grpc-js")),pn=v(require("got")),un=v(require("chalk"));async function no(t,{httpRegion:e,data:r}){let o=t(),s=o.next();if(!s.done){let n=g.javascript.scriptStart.exec(s.value.textLine);if(n==null?void 0:n.groups){let i=s.value.line;s=o.next();let a=[];for(;!s.done;){if(g.javascript.scriptEnd.test(s.value.textLine)){let l={script:j(a),lineOffset:i};if(!n.groups.modifier||n.groups.modifier==="@")switch(n.groups.event){case"request":e.hooks.onRequest.addHook(H.js,async(p,d)=>{await ge(l,d,"request")});break;case"streaming":e.hooks.onStreaming.addHook(H.js,async p=>{await ge(l,p,"streaming")});break;case"response":e.hooks.onResponse.addHook(H.js,async(p,d)=>{await ge(l,d,"response")});break;case"after":e.hooks.execute.addInterceptor(new lo(l));break;default:e.hooks.execute.addHook(H.js,p=>ge(l,p));break}else if(n.groups.modifier==="+"){let p=r.jsOnEveryRequest;p||(r.jsOnEveryRequest=p=[]),p.push({scriptData:l,event:n.groups.event})}return{nextParserLine:s.value.line,symbols:[{name:"script",description:"nodejs script",kind:R.script,startLine:i,startOffset:0,endLine:s.value.line,endOffset:s.value.textLine.length}]}}a.push(s.value.textLine),s=o.next()}}}return!1}async function io({data:t,httpRegion:e}){let r=t.jsOnEveryRequest;if(r&&e.request)for(let o of r){let s=o.scriptData;switch(o.event){case"streaming":e.hooks.onStreaming.addHook(H.js,async n=>{await ge(s,n,"streaming")});break;case"response":e.hooks.onResponse.addHook(H.js,async(n,i)=>{await ge(s,i,"response")});break;case"after":e.hooks.execute.addHook(H.js,async n=>{await ge(s,n,"after")});break;case"request":e.hooks.onRequest.addHook(H.js,async(n,i)=>{await ge(s,i,"request")});break;default:e.hooks.execute.addInterceptor(new ao(o.scriptData));break}}}var ao=class{constructor(e){this.scriptData=e}async beforeTrigger(e){return await ge(this.scriptData,e.arg,"before")}},lo=class{constructor(e){this.scriptData=e}async afterTrigger(e){return await ge(this.scriptData,e.arg,"after")}};async function ge(t,e,r){w(e,r?`execute javascript (@${r})`:"execute javascript");let o=await De(t.script,{fileName:e.httpFile.fileName,context:P({request:e.request,sleep:ue,test:dt(e),httpFile:e.httpFile,httpRegion:e.httpRegion,console:e.scriptConsole},e.variables),lineOffset:t.lineOffset,require:P({httpyac:exports,chalk:un.default,got:pn.default,"@grpc/grpc-js":la},e.require)});return o&&Q(o,e),!o.$cancel}async function po(t,e){let r=t();if(e.httpRegion.request){let o=pa(e),s=r.next();if(!s.done&&(o.rawBody.length>0||!G(s.value.textLine))){o.rawBody.push(da(s.value.textLine));let n=[];return!o.symbol||o.symbol.endLine!==s.value.line-1?(o.symbol={name:"request body",description:"request body",kind:R.requestBody,startLine:s.value.line,startOffset:0,endLine:s.value.line,endOffset:s.value.textLine.length},n.push(o.symbol)):(o.symbol.endLine=s.value.line,o.symbol.endOffset=s.value.textLine.length),{nextParserLine:s.value.line,symbols:n}}}return!1}function pa(t){let e=t.data.request_body;return e||(e={rawBody:[]},t.data.request_body=e),e}function ua(t){let e=t.data.request_body;return e&&delete t.data.request_body,e}function da(t){let e=g.request.fileImport.exec(t);return e&&e.length===4&&e.groups?{fileName:e.groups.fileName,injectVariables:!!e.groups.injectVariables,encoding:ca(e.groups.encoding)}:t}function ma(t){return["ascii","utf8","utf-8","utf16le","ucs2","ucs-2","base64","latin1","binary","hex"].indexOf(t)>=0}function ca(t){return t&&ma(t)?t:"utf8"}async function uo(t){let e=ua(t);t.httpRegion.request&&!!e&&(fa(e.rawBody),t.httpRegion.hooks.execute.addInterceptor(new Bt(e.rawBody)))}function fa(t){for(;t.length>0&&G(t[t.length-1]);)t.pop();if(t.length>0){let e=t[t.length-1];c(e)&&/\s*<--->\s*/u.test(e)&&t.pop()}}async function mo(t,e){let r=t(),o=r.next();if(!o.done&&ha(o.value.textLine,e.httpRegion)){if(e.httpRegion.request)return{endRegionLine:o.value.line-1,nextParserLine:o.value.line-1,symbols:[]};let s={name:o.value.textLine,description:"http request-line",kind:R.requestLine,startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length},n=[s],{request:i,requestSymbols:a}=ga(o.value.textLine,o.value.line);e.httpRegion.request=i,s.children=a;let l={nextParserLine:o.value.line,symbols:n},p={};i.headers=p;let d=X(r,[te,Z(p),ee((u,h)=>{var x;return Object.assign((x=h.request)==null?void 0:x.headers,u)}),on(u=>i.url+=u),fe(u=>i.url+=u)],e);if(d){l.nextParserLine=d.nextLine||l.nextParserLine;for(let u of d.parseResults)n.push(...u.symbols)}if(e.httpRegion.hooks.execute.addObjHook(u=>u.process,new qt,new At),e.httpRegion.hooks.execute.addInterceptor(new Y),e.httpRegion.request.headers){let u=F(e.httpRegion.request.headers,"content-type");c(u)&&(e.httpRegion.request.contentType=Ye(u))}return l}return!1}function ga(t,e){let r=[],o=g.request.requestLine.exec(t);return o&&o.length>1&&o.groups?(r.push({name:o.groups.method,description:"request method",kind:R.requestHeader,startLine:e,startOffset:t.indexOf(o.groups.method),endLine:e,endOffset:t.indexOf(o.groups.method)+o.groups.method.length},{name:o.groups.url,description:"request url",kind:R.url,startLine:e,startOffset:t.indexOf(o.groups.url),endLine:e,endOffset:t.length}),{request:{url:o.groups.url,method:Pt(o.groups.method)?o.groups.method:"GET",http2:o.groups.version?["1.1","1.0"].indexOf(o.groups.version)<0:void 0},requestSymbols:r}):(r.push({name:t.trim(),description:"request url",kind:R.url,startLine:e,startOffset:0,endLine:e,endOffset:t.length}),{request:{url:t.trim(),method:"GET"},requestSymbols:r})}function ha(t,e){var r,o;return G(t)?!1:e.request?!!((o=(r=g.request.requestLine.exec(t))==null?void 0:r.groups)==null?void 0:o.method):!0}async function co(t,e){var s,n,i,a;let r=t(),o=r.next();if(!o.done){let l=e.data.httpResponseSymbol;if(l)return l.body.push(o.value.textLine),l.symbol.endLine=o.value.line,l.symbol.endOffset=o.value.textLine.length,{nextParserLine:o.value.line,symbols:[]};let p=g.responseLine.exec(o.value.textLine);if(p&&((s=p.groups)==null?void 0:s.statusCode)){e.httpRegion.response={protocol:`HTTP/${p.groups.httpVersion||"1.1"}`,httpVersion:p.groups.httpVersion,statusCode:+p.groups.statusCode,statusMessage:p.groups.statusMessage,headers:{}};let d={name:"response",description:"response",kind:R.response,startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length};for(o=r.next();!o.done;){d.endLine=o.value.line,d.endOffset=o.value.textLine.length;let u=g.request.header.exec(o.value.textLine);if(((n=u==null?void 0:u.groups)==null?void 0:n.key)&&((i=u==null?void 0:u.groups)==null?void 0:i.value))e.httpRegion.response.headers=Object.assign((a=e.httpRegion.response)==null?void 0:a.headers,{[u.groups.key]:u.groups.value});else break;o=r.next()}return e.data.httpResponseSymbol={symbol:d,body:[]},{nextParserLine:d.endLine,symbols:[d]}}}return!1}async function fo(t){if(t.data.httpResponseSymbol){if(t.httpRegion.response&&t.data.httpResponseSymbol.body.length>0){let e=t.httpRegion.response,r=j(t.data.httpResponseSymbol.body);e.body=r,e.rawBody=Buffer.from(r),e.headers&&(e.contentType=Se(e.headers)),rt(e)}delete t.data.httpResponseSymbol}}async function go(t,{httpRegion:e}){var s;let o=t().next();if(!o.done){let n=o.value.textLine,i=g.responseRef.exec(n);if(i&&((s=i.groups)==null?void 0:s.fileName))return e.responseRefs||(e.responseRefs=[]),e.responseRefs.push(i.groups.fileName),{nextParserLine:o.value.line,symbols:[{name:i.groups.key,description:i.groups.value,kind:R.response,startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length}]}}return!1}async function ho(t,{httpRegion:e}){var s;let o=t().next();if(!o.done){let n=o.value.textLine,i=g.outputRedirection.exec(n);if(i&&((s=i.groups)==null?void 0:s.fileName)){let a=i.groups.fileName,l=!!i.groups.force;return e.hooks.onResponse.addHook("outputRedirection",async(p,d)=>{try{if(p.rawBody){let u=await ya(a,l,d.httpFile.fileName);u?await f.writeBuffer(u,p.rawBody):m.debug(`file ${a} not found`)}}catch(u){m.error(`outputredirection failed for ${a}`,u)}return p}),{nextParserLine:o.value.line,symbols:[{name:i.groups.key,description:i.groups.value,kind:R.response,startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length}]}}}return!1}async function ya(t,e,r){let o=await yo(t,r);if(!e&&await f.exists(o)){let s=t.lastIndexOf(".");if(s>0&&s<t.length-2){let n=t.slice(0,s),i=t.slice(s+1),a=1;for(o=await yo(`${n}-${a}.${i}`,r);await f.exists(o);)o=await yo(`${n}-${a++}.${i}`,r)}}return o}async function yo(t,e){if(!await f.isAbsolute(t)){let r=f.dirname(e);if(r)return f.joinPath(r,t)}return t}var bo="variable";async function Ro(t,{httpRegion:e}){let o=t().next();if(!o.done){let s=o.value.textLine,n=g.variable.exec(s);if(n&&n.groups&&n.groups.key&&n.groups.value){let i=n.groups.key,a=n.groups.value;return e.hooks.execute.hasHook(bo)||e.hooks.execute.addInterceptor(new dn),e.hooks.execute.addHook(bo,l=>{var p,d;if(l.options.replaceVariables=!0,nt(i))Q({[i]:a},l);else{let u=`Javascript Keyword ${i} not allowed as variable`;(d=(p=O).showWarnMessage)==null||d.call(p,u),m.warn(u)}return!0}),{nextParserLine:o.value.line,symbols:[{name:n.groups.key,description:n.groups.value,kind:R.variable,startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[{name:n.groups.key,description:"key",kind:R.key,startLine:o.value.line,startOffset:o.value.textLine.indexOf(n.groups.key),endLine:o.value.line,endOffset:o.value.textLine.indexOf(n.groups.key)+n.groups.key.length},{name:n.groups.value,description:"value",kind:R.value,startLine:o.value.line,startOffset:o.value.textLine.indexOf(n.groups.value),endLine:o.value.line,endOffset:o.value.textLine.indexOf(n.groups.value)+n.groups.value.length}]}]}}}return!1}var dn=class{constructor(){this.id=H.variable}async beforeTrigger(e){var r;return((r=e.hookItem)==null?void 0:r.id)!==bo&&e.arg.options.replaceVariables&&(await this.replaceAllVariables(e.arg),delete e.arg.options.replaceVariables),!0}async replaceAllVariables(e){for(let[r,o]of Object.entries(e.variables)){let s=await de(o,V.variable,e);s!==S&&(e.variables[r]=s)}return!0}};var mn=v(require("@grpc/proto-loader"));var cn=v(require("@grpc/grpc-js"));async function vo(t,e){var s;let r=t(),o=r.next();if(!o.done){let n=g.grpc.proto.exec(o.value.textLine);if((s=n==null?void 0:n.groups)==null?void 0:s.fileName){let i=new Ct(n.groups.fileName),l=[{name:o.value.textLine,description:"proto import",kind:R.proto,startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length}],p={nextParserLine:o.value.line,symbols:l},d=X(r,[te,Z(i.loaderOptions),ee((u,h)=>{var x;return Object.assign((x=h.options.protoDefinitions)==null?void 0:x[i.fileName].loaderOptions,u)})],e);if(d){p.nextParserLine=d.nextLine||p.nextParserLine;for(let u of d.parseResults)l.push(...u.symbols)}return e.httpRegion.hooks.execute.addObjHook(u=>u.process,new xo(i)),e.httpRegion.hooks.execute.addInterceptor(new ko(i)),p}}return!1}var xo=class{constructor(e){this.protoDefinition=e;this.id=H.protoImport}async process(e){var o;w(e,`import proto ${this.protoDefinition.fileName}`);let r=(o=e.options.protoDefinitions)==null?void 0:o[this.protoDefinition.fileName];if(r){let s=await this.convertLoaderOptions(r.loaderOptions,e);r.packageDefinition=await ye(this.protoDefinition.fileName,e,n=>(0,mn.load)(f.fsPath(n),s)),r.packageDefinition&&(r.grpcObject=(0,cn.loadPackageDefinition)(r.packageDefinition))}return!0}async convertLoaderOptions(e,r){var n,i;let o=P({},e),s=j(Object.entries(o).filter(([,a])=>c(a)).map(([a,l])=>`${a}: ${l},`));try{Object.assign(o,await z(`{${s}}`,r))}catch(a){let l=`proto-loader options convert failed: ${s}`;(i=(n=O).showWarnMessage)==null||i.call(n,l),m.warn(l,a)}return o}},ko=class{constructor(e){this.protoDefinition=e;this.id=H.protoCreate}async beforeLoop(e){return e.arg.options.protoDefinitions=Object.assign({},e.arg.options.protoDefinitions,{[this.protoDefinition.fileName]:{fileName:this.protoDefinition.fileName,loaderOptions:P({},this.protoDefinition.loaderOptions)}}),!0}};async function fn(t,e){var s,n;let r=t(),o=r.next();if(!o.done&&Ra(o.value.textLine,e.httpRegion)){if(e.httpRegion.request)return{endRegionLine:o.value.line-1,nextParserLine:o.value.line-1,symbols:[]};let i=ba(o.value.textLine,o.value.line);if(!i)return!1;e.httpRegion.request=i.request;let a={name:o.value.textLine,description:"grpc request-line",kind:R.requestLine,startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[i.symbol]},l={nextParserLine:o.value.line,symbols:[a]},p={};i.request.headers=p;let d=X(r,[te,Z(p),ee((u,h)=>{var x;return Object.assign((x=h.request)==null?void 0:x.headers,u)}),fe(u=>i.request.url+=u)],e);if(d){l.nextParserLine=d.nextLine||l.nextParserLine;for(let u of d.parseResults)(n=(s=l.symbols)==null?void 0:s.push)==null||n.call(s,...u.symbols)}return e.httpRegion.hooks.execute.addObjHook(u=>u.process,new $t),e.httpRegion.hooks.execute.addInterceptor(new Y),l}return!1}function ba(t,e){let r=g.grpc.grpcLine.exec(t);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,method:"GRPC"},symbol:{name:r.groups.url,description:"grpc url",kind:R.url,startLine:e,startOffset:0,endLine:e,endOffset:t.length}};let o=g.grpc.grpcProtocol.exec(t);if(o&&o.length>1&&o.groups)return{request:{url:o.groups.url,method:"GRPC"},symbol:{name:o.groups.url,description:"grpc url",kind:R.url,startLine:e,startOffset:0,endLine:e,endOffset:t.length}}}function Ra(t,e){var r,o,s,n;return G(t)?!1:((o=(r=g.grpc.grpcLine.exec(t))==null?void 0:r.groups)==null?void 0:o.url)?!0:e.request?!1:(n=(s=g.grpc.grpcProtocol.exec(t))==null?void 0:s.groups)==null?void 0:n.url}async function wo(t,e){var s,n;let r=t(),o=r.next();if(!o.done&&xa(o.value.textLine,e.httpRegion)){if(e.httpRegion.request)return{endRegionLine:o.value.line-1,nextParserLine:o.value.line-1,symbols:[]};let i=va(o.value.textLine,o.value.line);if(!i)return!1;e.httpRegion.request=i.request;let a={name:o.value.textLine,description:"WebSocket request-line",kind:R.requestLine,startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[i.symbol]},l={nextParserLine:o.value.line,symbols:[a]},p={};i.request.headers=p;let d=X(r,[te,Z(p),ee((u,h)=>{var x;return Object.assign((x=h.request)==null?void 0:x.headers,u)}),fe(u=>i.request.url+=u)],e);if(d){l.nextParserLine=d.nextLine||l.nextParserLine;for(let u of d.parseResults)(n=(s=l.symbols)==null?void 0:s.push)==null||n.call(s,...u.symbols)}return e.httpRegion.hooks.execute.addObjHook(u=>u.process,new Nt),e.httpRegion.hooks.execute.addInterceptor(new Y),l}return!1}function va(t,e){let r=g.stream.websocketLine.exec(t);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,method:"WS"},symbol:{name:r.groups.url,description:"WebSocket Url",kind:R.url,startLine:e,startOffset:0,endLine:e,endOffset:t.length}};let o=g.stream.websocketProtocol.exec(t);if(o&&o.length>1&&o.groups)return{request:{url:o.groups.url,method:"WS"},symbol:{name:o.groups.url,description:"WebSocket Url",kind:R.url,startLine:e,startOffset:0,endLine:e,endOffset:t.length}}}function xa(t,e){var r,o,s,n;return G(t)?!1:((o=(r=g.stream.websocketLine.exec(t))==null?void 0:r.groups)==null?void 0:o.url)?!0:e.request?!1:(n=(s=g.stream.websocketProtocol.exec(t))==null?void 0:s.groups)==null?void 0:n.url}async function Co(t,e){var s,n;let r=t(),o=r.next();if(!o.done&&wa(o.value.textLine,e.httpRegion)){if(e.httpRegion.request)return{endRegionLine:o.value.line-1,nextParserLine:o.value.line-1,symbols:[]};let i=ka(o.value.textLine,o.value.line);if(!i)return!1;e.httpRegion.request=i.request;let a={name:o.value.textLine,description:"MQTT request-line",kind:R.requestLine,startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[i.symbol]},l={nextParserLine:o.value.line,symbols:[a]},p={};i.request.headers=p;let d=X(r,[te,Z(p),ee((u,h)=>{var x;return Object.assign((x=h.request)==null?void 0:x.headers,u)}),fe(u=>i.request.url+=u)],e);if(d){l.nextParserLine=d.nextLine||l.nextParserLine;for(let u of d.parseResults)(n=(s=l.symbols)==null?void 0:s.push)==null||n.call(s,...u.symbols)}return e.httpRegion.hooks.execute.addObjHook(u=>u.process,new Mt),e.httpRegion.hooks.execute.addInterceptor(new Y),l}return!1}function ka(t,e){let r=g.stream.mqttLine.exec(t);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,method:"MQTT"},symbol:{name:r.groups.url,description:"MQTT Url",kind:R.url,startLine:e,startOffset:0,endLine:e,endOffset:t.length}};let o=g.stream.mqttProtocol.exec(t);if(o&&o.length>1&&o.groups)return{request:{url:o.groups.url,method:"MQTT"},symbol:{name:o.groups.url,description:"MQTT Url",kind:R.url,startLine:e,startOffset:0,endLine:e,endOffset:t.length}}}function wa(t,e){var r,o,s,n;return G(t)?!1:((o=(r=g.stream.mqttLine.exec(t))==null?void 0:r.groups)==null?void 0:o.url)?!0:e.request?!1:(n=(s=g.stream.mqttProtocol.exec(t))==null?void 0:s.groups)==null?void 0:n.url}async function Po({httpRegion:t}){if(t.metaData.note){let e=t.metaData.note||`Are you sure you want to send the request ${at(t)}?`;t.hooks.execute.addInterceptor({beforeLoop:()=>O.showNote(e)})}}function gn(t){t.httpRegion.hooks.execute.addInterceptor({beforeLoop:async function(r){var o,s;return((s=(o=r.arg.progress)==null?void 0:o.isCanceled)==null?void 0:s.call(o))?(m.trace("processs canceled by user"),!1):!0}})}var I;(function(k){k.meta="meta",k.comment="comment",k.variable="variable",k.javascript="javascript",k.note="note",k.intellijScript="intellijScript",k.gql="gql",k.outputRedirection="outputRedirection",k.request="request",k.responseRef="responseRef",k.response="response",k.requestBody="requestBody",k.proto="proto",k.grpc="grpc",k.eventSource="eventSource",k.mqtt="mqtt",k.websocket="websocket"})(I||(I={}));function Ho(){let t=new bt;return t.addHook(I.meta,eo),t.addHook(I.comment,Fr),t.addHook(I.variable,Ro),t.addHook(I.javascript,no),t.addHook(I.intellijScript,so),t.addHook(I.gql,ro),t.addHook(I.proto,vo),t.addHook(I.grpc,fn),t.addHook(I.websocket,wo),t.addHook(I.eventSource,to),t.addHook(I.mqtt,Co),t.addHook(I.request,mo),t.addHook(I.outputRedirection,ho),t.addHook(I.responseRef,go),t.addHook(I.response,co),t.addHook(I.requestBody,po),t}function So(){let t=new Rt;return t.addHook("registerCancelExecutionIntercepter",gn),t.addHook(I.note,Po),t.addHook(I.javascript,io),t.addHook(I.response,fo),t.addHook(I.requestBody,uo),t}var Wo={};ie(Wo,{provider:()=>Ue,replacer:()=>gt});var gt={};ie(gt,{VariableReplacerType:()=>_,awsAuthVariableReplacer:()=>Lo,basicAuthVariableReplacer:()=>qo,clientCertVariableReplacer:()=>To,digestAuthVariableReplacer:()=>Io,escapeVariableReplacer:()=>$o,hostVariableReplacer:()=>Ao,initReplaceVariableHook:()=>ja,intellijVariableReplacer:()=>Fo,javascriptVariableReplacer:()=>jo,oauth2VariableReplacer:()=>Vo,restClientVariableReplacer:()=>Uo,showInputBoxVariableReplacer:()=>_o,showQuickpickVariableReplacer:()=>Go});var hn=v(require("url"));var Ca=require("aws4");async function Lo(t,e,{request:r}){var o;if(e.toLowerCase()==="authorization"&&c(t)&&K(r)&&(r==null?void 0:r.url)){let s=g.auth.aws.exec(t);if(s&&s.groups&&s.groups.accessKeyId&&s.groups.secretAccessKey){let n={accessKeyId:s.groups.accessKeyId,secretAccessKey:s.groups.secretAccessKey,sessionToken:s.groups.token},i=new hn.URL(r.url),a={method:r.method,headers:r.headers,host:i.host,path:i.pathname,region:s.groups.region,service:s.groups.service},l=await Ca.sign(a,n);return Object.assign(r,{http2:!1}),(o=l.headers)==null?void 0:o.Authorization}}return t}async function qo(t,e){if(e.toLowerCase()==="authorization"&&c(t)){let r=g.auth.basicColon.exec(t)||g.auth.basic.exec(t);if(r&&r.groups&&r.groups.user&&r.groups.password)return`Basic ${Buffer.from(`${r.groups.user}:${r.groups.password}`).toString("base64")}`}return t}var yn=v(require("url"));async function To(t,e,r){var i,a,l,p;let{request:o,httpRegion:s,httpFile:n}=r;if(c(t)&&K(o)&&!s.metaData.noClientCert){if(e===V.url&&((i=r.config)==null?void 0:i.clientCertificates)){let d=Pa(t);if(d){let u=(a=r.config)==null?void 0:a.clientCertificates[d.host];u&&await bn(o,u,n)}}else if(e.toLowerCase().endsWith("clientcert")){let d=g.auth.clientCert.exec(t);if(((l=d==null?void 0:d.groups)==null?void 0:l.cert)||((p=d==null?void 0:d.groups)==null?void 0:p.pfx)){await bn(o,{cert:d.groups.cert,key:d.groups.key,pfx:d.groups.pfx,passphrase:d.groups.passphrase},n);return}}}return t}function Pa(t){try{return new yn.URL(t)}catch{return}}async function bn(t,e,r){t.https=Object.assign({},t.https,{certificate:await Eo(e.cert,r.fileName),key:await Eo(e.key,r.fileName),pfx:await Eo(e.pfx,r.fileName),passphrase:e.passphrase})}async function Eo(t,e){if(t)if(c(t)){let r=await D(t,e);if(r)return await f.readBuffer(r)}else return await f.readBuffer(t)}var Rn=v(require("crypto")),vn=v(require("uuid")),xn=v(require("url"));async function Io(t,e,{request:r}){if(e.toLowerCase()==="authorization"&&c(t)&&K(r)){let o=g.auth.digest.exec(t);if(o&&o.groups&&o.groups.user&&o.groups.password){r.hooks||(r.hooks={}),r.hooks.afterResponse||(r.hooks.afterResponse=[]),r.hooks.afterResponse.push(Ha(o.groups.user,o.groups.password));return}}return t}function Ha(t,e){return function(o,s){let n=o.headers["www-authenticate"];if(o.statusCode===401&&n&&n.toLowerCase().startsWith("digest")){let i=new xn.URL(o.url),a={qop:"",algorithm:"",realm:"",nonce:"",opaque:""};La(a,n);let l=/(^|,)\s*auth\s*($|,)/u.test(a.qop)&&"auth",p=l&&"00000001",d=l&&(0,vn.v4)().replace(/-/gu,""),u=Oa(a.algorithm,t,e,a.realm,a.nonce,d),h=mt(`${o.request.options.method}:${i.pathname}`),x=mt(l?`${u}:${a.nonce}:${p}:${d}:${l}:${h}`:`${u}:${a.nonce}:${h}`);return s({headers:{authorization:`Digest ${Sa({username:t,realm:a.realm,nonce:a.nonce,uri:i.pathname,qop:l,response:x,nc:p,cnonce:d,algorithm:a.algorithm,opaque:a.opaque})}`}})}return o}}function Sa(t){let e=[];for(let[r,o]of Object.entries(t))o&&(["qop","nc","algorithm"].indexOf(r)>=0?e.push(`${r}=${o}`):e.push(`${r}="${o}"`));return e.join(", ")}function mt(t){return(0,Rn.createHash)("md5").update(t).digest("hex")}function Oa(t,e,r,o,s,n){let i=mt(`${e}:${o}:${r}`);return n&&(t==null?void 0:t.toLowerCase())==="md5-sess"?mt(`${i}:${s}:${n}`):i}function La(t,e){for(let r of e.split(",")){let o=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/giu.exec(r);o&&(t[o[1]]=o[2]||o[3])}}async function $o(t){if(c(t)){let e=/(?:\\\{){2}([^}{2}]+)(?:\\\}){2}/gu,r,o=t;for(;c(o)&&(r=e.exec(t))!==null;){let[s,n]=r;o=o.replace(s,`{{${n}}}`)}return o}return t}async function Ao(t,e,{variables:r}){return c(t)&&V.url===e&&!!r.host&&t.startsWith("/")?`${r.host}${t}`:t}var kn=v(require("uuid"));async function Fo(t){if(!c(t))return t;let e,r=t;for(;(e=g.javascript.scriptSingleLine.exec(t))!==null;){let[o,s]=e,n=null;switch(s.trim()){case"$uuid":n=(0,kn.v4)();break;case"$timestamp":n=Date.now();break;case"$randomInt":n=Math.floor(Math.random()*1e3);break;default:n=null;break}n&&(r=r.replace(o,`${n}`))}return r}async function jo(t,e,r){if(!c(t))return t;let o,s,n=t;for(;s!==n;)for(s=n;(o=g.javascript.scriptSingleLine.exec(s))!==null;){let[i,a]=o;try{let l=await z(a,r);c(l)||typeof l=="number"?n=n.replace(i,`${l}`):l instanceof Date?n=n.replace(i,`${l.toISOString()}`):l&&(n=n.replace(i,`${l}`))}catch(l){if(e===V.variable)m.trace(`variable ${a} not defined`);else throw l}}return n}var wn=v(require("lodash/get"));function J(t,e,r){return t[`${e}_${r}`]||(0,wn.default)(t,`${e}.${r}`)}function Do(t,e){return t?{variablePrefix:t,authorizationEndpoint:J(e,t,"authorizationEndpoint"),deviceCodeEndpoint:J(e,t,"deviceCodeEndpoint"),tokenEndpoint:J(e,t,"tokenEndpoint"),clientId:J(e,t,"clientId"),clientSecret:J(e,t,"clientSecret"),responseType:J(e,t,"responseType"),responseMode:J(e,t,"responseMode"),audience:J(e,t,"audience"),scope:J(e,t,"scope"),username:J(e,t,"username"),password:J(e,t,"password"),subjectIssuer:J(e,t,"subjectIssuer"),keepAlive:["true","1",!0].indexOf(J(e,t,"keepAlive"))<0,useAuthorizationHeader:["false","0",!1].indexOf(J(e,t,"useAuthorizationHeader"))<0}:!1}function re(t,e){var o,s;let r=[];for(let n of e)Object.entries(t).some(([i,a])=>i===n&&!!a)||r.push(n);if(r.length>0){let n=`missing configuration: ${r.map(i=>`${t.variablePrefix}_${i}`).join(", ")}`;return m.error(n),(s=(o=O).showErrorMessage)==null||s.call(o,n),!1}return!0}async function oe(t,e,r){if(t){let o=new Date().getTime();t.headers||(t.headers={"content-type":"application/x-www-form-urlencoded"}),t.headers&&e.config.useAuthorizationHeader?t.headers.authorization=`Basic ${Buffer.from(`${e.config.clientId}:${e.config.clientSecret}`).toString("base64")}`:t.body=`${t.body}&${B({client_id:e.config.clientId,client_secret:e.config.clientSecret})}`;let s=await(r==null?void 0:r.httpClient(t,{showProgressBar:!1}));if(s&&($e(r)&&await N(s,r),s.statusCode===200&&c(s.body)))return ct(JSON.parse(s.body),o,e)}return!1}function ct(t,e,r){if(qa(t)){let o=Oe(t.access_token);return o&&m.debug(JSON.stringify(o,null,2)),T(P({},r),{type:"OAuth2",time:e,accessToken:t.access_token,expiresIn:t.expires_in,refreshToken:t.refresh_token,refreshExpiresIn:t.refresh_expires_in,timeSkew:(o==null?void 0:o.iat)?Math.floor(e/1e3)-o.iat:0})}return!1}function qa(t){let e=t;return e&&!!e.access_token&&!!e.expires_in}var Ln=v(require("open"));var Cn=v(require("http"));var he=[],_e,_t,Gt=0;function Wt(t){he.push(t),Ta()}function Ce(t){let e=he.findIndex(r=>r.id===t);e>=0&&he.splice(e,1),he.length===0&&Hn(60)}function Pn(){_t&&(clearTimeout(_t),_t=!1,Gt=0)}function Hn(t){Pn();let e=t*1e3;Gt=new Date().getTime()+e,_t=setTimeout(()=>Sn(),e)}function Sn(){for(let t of he)t.reject();he.length=0,_e&&(Pn(),_e.close(t=>{t?m.error(t):m.debug("http server closed")}),_e=!1)}function Ta(t=3e3){Hn(600),_e||(m.debug(`open http server on port ${t}`),_e=(0,Cn.createServer)((e,r)=>{try{let o="invalid",s=500,n=[];if(e.url){let i=Ea(e.url);if(e.url.startsWith("/callback")){let a=he.find(l=>l.id===i.state);if(a){let l=a.resolve(i);n.push(ft(l.message,l.valid)),l.valid&&(s=200,Ce(a.id)),o=l.statusMessage}else n.push(ft("invalid state received",!1)),n.push(`
                <script>
                  if(window.location.hash){
                    window.document.querySelector('.js-message').remove();
                    window.location.replace(\`\${window.location.href.substring(0,window.location.href.indexOf('#'))}?\${window.location.hash.substring(1)}\`);
                  }
                <\/script>
                <noscript>
                  ${ft("Please enable javascript for redirect or replace fragment (#) with query (?)",!1)}
                </noscript>
              `),o="invalid state received"}else if(e.url.startsWith("/reject")){let a=he.find(l=>l.id===i.id);a?(a.reject(),Ce(i.id),s=200,o="listener removed",n.push(ft(`${a.name} removed`,!0))):o="listener not found"}else e.url.startsWith("/shutdown")&&(Sn(),n.push(ft("server closed",!0)),s=200,o="server was shut down")}n.push(Ia()),r.setHeader("Content-Type","text/html"),r.writeHead(s,o),r.end(On(n.join("")))}catch(o){m.error(o),r.end(On(`${o}`))}}),_e.listen(t))}function Ea(t){return t.slice(t.indexOf("?")+1).split("&").reduce((e,r)=>{let[o,s]=r.split("=");return e[o]=s,e},{})}function ft(t,e){return`
<div class="card js-message ${e?"card--success":"card--error"}">
  <h3 class="card__title">${e?"success":"error"}</h3>
  <div class="card__message">${t}</div>
</div>`}function Ia(){let t=[];return he.length>0&&t.push(...he.map(e=>`
      <div class="card">
        <h3 class="card__title">open requests</h3>
        <div class="card__message">${e.name}</div>
        <div class="card__actions">
          <a href="/reject?id=${e.id}">remove</a>
        </div>
      </div>`)),Gt>0&&t.push(`
    <div class="card">
      <h3 class="card__title">Server Status</h3>
      <div class="card__message">automatic shutdown in ${$a(Math.floor((Gt-new Date().getTime())/1e3))}</div>
      <div class="card__actions">
        <a href="/shutdown">shutdown</a>
      </div>
    </div>`),t.join("")}function $a(t){if(t>0){let e=Math.trunc(t/60),r=t%60;return e>0?r>0?`${e}minute${e>1?"s":""} ${r} seconds`:`${e} minute${e>1?"s":""}`:`${t} seconds`}return"-"}function On(t){return`
  <html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>httpYac</title>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <style>
    :root{
      --light: #FAFAFA;
      --success: #4CAF50;
      --success-dark: #43A047;
      --error: #D32F2F;
      --error-dark: #C62828;
      --link-light: #E1F5FE;
      --link: #00B0FF;
      --link-dark: #0091EA;
    }
      body{
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        background-color: var(--light);
        display:flex;
        align-items: center;
        flex-direction: column;
      }

      .card{
        border-radius: 4px;
        background-color: #FFF;
        box-shadow: 0px 2px 1px -1px rgb(0 0 0 / 20%), 0px 1px 1px 0px rgb(0 0 0 / 14%), 0px 1px 3px 0px rgb(0 0 0 / 12%);
        width: 22rem;
        padding: .5rem;
        margin: auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin: 2rem;
      }

      .card--success{
        border-bottom: 1rem solid var(--success);
      }
      .card--success:hover{
        border-bottom: 1rem solid var(--success-dark);
      }

      .card--error{
        border-bottom: 1rem solid var(--error);
      }
      .card--error:hover{
        border-bottom: 1rem solid var(--error-dark);
      }
      .card__title{
        margin: 0 .5rem;
      }
      .card__message{
        padding: 0 .5rem;
        word-break: break-word;
      }
      .card__actions{
        padding: 1rem 0;
      }
      a {
          color: var(--link);
          text-decoration:none;
          border-radius:3px;
          cursor:pointer;
          text-transform: uppercase;
          padding: .5rem;
      }
      a:focus {
        outline-color: var(--link);
        color: var(--link);
      }
      a:hover, a:active {
          color: var(--link-dark);
          background-color: var(--link-light);
      }
    </style>
  </head>
  <body>
  <img src="https://raw.githubusercontent.com/AnWeber/vscode-httpyac/master/icon.png" alt="HttpYac Logo" />
${t}
</body>
</html>
`}var qn=class{supportsFlow(e){return["authorization_code","code"].indexOf(e)>=0}getCacheKey(e){return re(e,["tokenEndpoint","authorizationEndpoint","clientId","clientSecret"])?`authorization_code_${e.clientId}_${e.tokenEndpoint}`:!1}async perform(e,r){let o=this.getCacheKey(e);return o?new Promise((s,n)=>{let i=Ae();try{w(r,"execute OAuth2 authorization_code flow");let a="http://localhost:3000/callback",l=`${e.authorizationEndpoint}${e.authorizationEndpoint.indexOf("?")>0?"&":"?"}${B({client_id:e.clientId,scope:e.scope||"openid",response_type:"code",state:i,audience:e.audience,redirect_uri:a})}`,p;r.progress&&(p=r.progress.register(()=>{Ce(i),n(new Error("process canceled"))})),Wt({id:i,name:`authorization for ${e.clientId}: ${e.authorizationEndpoint}`,resolve:d=>{if(d.code&&d.state===i){p&&p();let u=oe({url:e.tokenEndpoint,method:"POST",body:B({grant_type:"authorization_code",scope:e.scope,code:d.code,redirect_uri:a})},{config:e,id:o,title:`authorization_code: ${e.clientId}`,description:`${e.variablePrefix} - ${e.tokenEndpoint}`,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"authorization_code"}},r);return s(u),{valid:!0,message:"code received.",statusMessage:"code and state valid. starting code exchange"}}return d.error_description?{valid:!1,message:decodeURIComponent(d.error_description),statusMessage:"no access_token received"}:{valid:!1,message:"no code received",statusMessage:"no code received"}},reject:n}),w(r,`autorization_code browser authentication pending: ${l}`),(0,Ln.default)(l)}catch(a){Ce(i),n(a)}}):!1}},Tn=new qn;var En=class{supportsFlow(e){return["client_credentials","client"].indexOf(e)>=0}getCacheKey(e){return re(e,["tokenEndpoint","clientId","clientSecret"])?`client_credentials_${e.clientId}_${e.tokenEndpoint}`:!1}async perform(e,r){let o=this.getCacheKey(e);return o?(w(r,"execute OAuth2 client_credentials flow"),oe({url:e.tokenEndpoint,method:"POST",body:B({grant_type:"client_credentials",scope:e.scope})},{config:e,id:o,title:`clientCredentials: ${e.clientId}`,description:`${e.variablePrefix} - ${e.tokenEndpoint}`,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"client_credentials"}},r)):!1}},In=new En;var $n=v(require("open")),An=class{supportsFlow(e){return["device_code","device"].indexOf(e)>=0}getCacheKey(e){return re(e,["tokenEndpoint","deviceCodeEndpoint","clientId"])?`device_code_${e.clientId}_${e.tokenEndpoint}`:!1}async perform(e,r){var s,n,i,a;let o=this.getCacheKey(e);if(o){w(r,"execute device_code authorization flow");let l=new Date().getTime(),p=await this.requestDeviceAuthorization(r,e);if(p&&p.statusCode===200&&c(p.body)){$e(r)&&await N(p,r),w(r,"device_code received");let d=JSON.parse(p.body),u=d.interval?Number(d.interval)*1e3:5e3;for(Number.isNaN(u)&&(u=5e3),this.showUserCode(d);new Date().getTime()-l<Number(d.expires_in)*1e3;)try{if(await ue(u),(n=(s=r.progress)==null?void 0:s.isCanceled)==null?void 0:n.call(s))return!1;let h=new Date().getTime(),x=await this.authenticateUser(r,e,d);if(x&&c(x.body)){let q=JSON.parse(x.body);if(x.statusCode===200)return w(r,"accessToken received"),await this.logResponse(x,r),ct(q,h,{config:e,id:o,title:`deviceCode: ${e.clientId}`,description:`${e.variablePrefix} - ${e.tokenEndpoint}`,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"device_code"}});if(w(r,`device code ${q.error}`),["slow_down","authorization_pending"].indexOf(q.error)>=0)(q.error==="slow_down"||x.statusCode===408)&&(u+=5e3,m.debug(`DeviceCode Flow increase interval: ${u}`));else{if(q.error&&["access_denied","expired_token","bad_verification_code"].indexOf(q.error)>=0)return m.debug(`DeviceCode Flow aborted: ${q.error_description||""}`),await this.logResponse(x,r),!1;if(await((a=(i=O).showWarnMessage)==null?void 0:a.call(i,`Unknown error code ${q.error}`,"Continue","Cancel"))==="Cancel")return await this.logResponse(x,r),!1}}else return m.debug("device code received invalid response"),!1}catch(h){return m.debug(h),!1}}}return!1}async logResponse(e,r){$e(r)&&await N(e,r)}async authenticateUser(e,r,o){return await(e==null?void 0:e.httpClient({url:r.tokenEndpoint,method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:B({client_id:r.clientId,grant_type:"urn:ietf:params:oauth:grant-type:device_code",code:o.device_code})},{showProgressBar:!1}))}async requestDeviceAuthorization(e,r){return await(e==null?void 0:e.httpClient({url:r.deviceCodeEndpoint,method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:B({client_id:r.clientId,scope:r.scope||"openid"})},{showProgressBar:!1}))}showUserCode(e){let r=e.message||`To sign in, use a web browser to open the page ${e.verification_uri_complete} and enter the code ${e.user_code} to authenticate.`;m.info(r),m.info(`Verfication_Uri: ${e.verification_uri_complete||e.verification_uri}`),m.info(`User_Code: ${e.user_code}`);let o=async()=>{var s,n;await((n=(s=O).setClipboard)==null?void 0:n.call(s,e.user_code)),await(0,$n.default)(e.verification_uri_complete||e.verification_uri)};O.showInformationMessage?O.showInformationMessage(r,"Open").then(s=>{s&&o()}):o()}},Fn=new An;var jn=v(require("open"));var Dn=class{supportsFlow(e){return["implicit","hybrid"].indexOf(e)>=0}getCacheKey(e){return re(e,["tokenEndpoint","authorizationEndpoint","clientId"])?`implicit_${e.clientId}_${e.tokenEndpoint}`:!1}async perform(e,r){let o=this.getCacheKey(e);return o?new Promise((s,n)=>{w(r,"execute OAuth2 implicit flow");let i=Ae();try{let a="http://localhost:3000/callback",l=`${e.authorizationEndpoint}${e.authorizationEndpoint.indexOf("?")>0?"&":"?"}${B({client_id:e.clientId,scope:e.scope||"openid",response_type:e.responseType||"token",nonce:Ae(),state:i,response_mode:e.responseMode,audience:e.audience,redirect_uri:a})}`,p;r.progress&&(p=r.progress.register(()=>{Ce(i),n(new Error("progress cancel"))})),Wt({id:i,name:`authorization for ${e.clientId}: ${e.authorizationEndpoint}`,resolve:d=>{if(d.state===i){if(d.code){let u=oe({url:e.tokenEndpoint,method:"POST",body:B({grant_type:"authorization_code",scope:e.scope,code:d.code,redirect_uri:a})},{config:e,id:o,title:`implicit: ${e.clientId}`,description:`${e.variablePrefix} - ${e.tokenEndpoint}`,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"implicit"}},r);return s(u),{valid:!0,message:"code received.",statusMessage:"code valid. starting code exchange"}}if(d.access_token){p&&p();let u=ct(d,new Date().getTime(),{config:e,id:o,title:`implicit: ${e.clientId}`,description:e.tokenEndpoint,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"implicit"}});return s(u),{valid:!0,message:"access_token received.",statusMessage:"access_token and state valid."}}}return d.error_description?{valid:!1,message:decodeURIComponent(d.error_description),statusMessage:"no access_token received"}:{valid:!1,message:"no access_token received",statusMessage:"no access_token received"}},reject:n}),m.trace(`open browser: ${l}`),w(r,`implicit browser authentication pending: ${l}`),(0,jn.default)(l)}catch(a){Ce(i),n(a)}}):!1}},Mn=new Dn;var Bn=class{isTokenExpired(e,r,o){return typeof o!="undefined"?e+1e3*(o-r)<new Date().getTime():!1}async perform(e,r){return this.isTokenExpired(e.time,e.timeSkew,e.expiresIn)?e.refreshToken&&!this.isTokenExpired(e.time,e.timeSkew,e.refreshExpiresIn)?(w(r,"execute OAuth2 refresh_token flow"),oe({url:e.config.tokenEndpoint,method:"POST",body:B({grant_type:"refresh_token",refresh_token:e.refreshToken})},{config:e.config,id:e.id,title:e.title,description:e.description,details:{clientId:e.config.clientId,tokenEndpoint:e.config.tokenEndpoint,grantType:"refresh_token"}},r)):!1:e}},Mo=new Bn;var Vn=class{supportsFlow(e){return["password"].indexOf(e)>=0}getCacheKey(e){return re(e,["tokenEndpoint","clientId","clientSecret","username","password"])?`password_${e.clientId}_${e.username}_${e.tokenEndpoint}`:!1}async perform(e,r){let o=this.getCacheKey(e);return o?(w(r,"execute OAuth2 password flow"),oe({url:e.tokenEndpoint,method:"POST",body:B({grant_type:"password",scope:e.scope,username:e.username,password:e.password})},{config:e,id:o,title:`PasswordFlow: ${e.username} (${e.clientId})`,description:`${e.variablePrefix} - ${e.tokenEndpoint}`,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"password",username:e.username}},r)):!1}},Nn=new Vn;var Un=v(require("encodeurl")),Bo=class{static getCacheKey(e){return re(e,["tokenEndpoint","clientId","clientSecret"])?`${e.tokenEndpoint}_${e.clientId}`:!1}static async perform(e,r,o){if(r){w(o,"execute OAuth2 token exchange flow");let s=Oe(r.accessToken);return oe({url:e.tokenEndpoint,method:"POST",body:B({grant_type:"urn:ietf:params:oauth:grant-type:token-exchange",requested_token_type:"urn:ietf:params:oauth:token-type:access_token",subject_token_type:"urn:ietf:params:oauth:token-type:access_token",scope:e.scope||"openid",subject_issuer:e.subjectIssuer||(s==null?void 0:s.iss),subject_token:(0,Un.default)(r.accessToken)})},{config:e,id:r.id,title:`${r.title} (token exchange)`,description:r.description,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"urn:ietf:params:oauth:grant-type:token-exchange"}},o)}return!1}};async function Vo(t,e,r){if(e.toLowerCase()==="authorization"&&c(t)){let o=g.auth.oauth2.exec(t);if(o&&o.groups){let s=o.groups.flow||"client_credentials",n=Do(o.groups.variablePrefix||"oauth2",r.variables),i=Do(o.groups.tokenExchangePrefix,r.variables),a=Fa(s);if(a&&n){let l=a.getCacheKey(n);if(l){let p=Aa(l,i||n);if(U.removeUserSession(l),p&&(m.trace(`openid refresh token flow used: ${l}`),p=await Mo.perform(p,r)),p||(m.trace(`openid flow ${s} used: ${l}`),p=await a.perform(n,r),p&&i&&(p=await Bo.perform(i,p,r))),p)return m.trace(`openid flow ${s} finished`),r.variables.oauth2Session=p,U.setUserSession(p),Gn(l,r.httpClient),`Bearer ${p.accessToken}`}return S}}}return t}function Aa(t,e){let r=U.userSessions.find(o=>o.id===t);return _n(r)&&JSON.stringify(r.config)===JSON.stringify(e)?r:!1}function _n(t){let e=t;return!!(e==null?void 0:e.accessToken)}function Fa(t){return[Tn,In,Fn,Nn,Mn].find(r=>r.supportsFlow(t))}function Gn(t,e){let r=U.userSessions.find(o=>o.id===t);if(_n(r)&&r.refreshToken&&r.config.keepAlive){let o=setTimeout(async()=>{let s=await Mo.perform(r,{httpClient:e});s&&(m.trace(`token ${s.title} refreshed`),U.setUserSession(s),Gn(t,e))},(r.expiresIn-r.timeSkew)*1e3);r.delete=()=>clearTimeout(o)}}var Wn=v(require("uuid")),Ge=v(require("dayjs")),No=v(require("dayjs/plugin/utc"));Ge.default.extend(No.default);async function Uo(t,e,{variables:r}){var n,i,a,l,p,d,u,h,x,q,y,b;if(!c(t))return t;let o,s=t;for(;(o=g.javascript.scriptSingleLine.exec(t))!==null;){let[k,C]=o,$=C.trim(),M=null;if($==="$guid")M=(0,Wn.v4)();else if($.startsWith("$randomInt")){let L=/^\$randomInt\s*(?<min>-?\d+)?\s*(?<max>-?\d+)?\s*$/u.exec($);if(L&&((n=L.groups)==null?void 0:n.min)&&((i=L.groups)==null?void 0:i.max)){let A=Number((a=L.groups)==null?void 0:a.min),Je=Number((l=L.groups)==null?void 0:l.max);if(!Number.isNaN(A)&&!Number.isNaN(Je)){if(A>Je){let ii=Je;Je=A,A=ii}M=`${Math.floor(Math.random()*(Je-A))+A}`}}}else if($.startsWith("$timestamp")){let L=/^\$timestamp(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec($);if(L){Ge.default.extend(No.default);let A=Ge.default.utc();((p=L.groups)==null?void 0:p.offset)&&((d=L.groups)==null?void 0:d.option)&&(A=A.add(Number(L.groups.offset),L.groups.option)),M=`${A.unix()}`}}else if($.startsWith("$datetime")){let L=/^\$datetime\s(?<type>rfc1123|iso8601|'.+'|".+")(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec($);if((u=L==null?void 0:L.groups)==null?void 0:u.type){let A=Ge.default.utc();((h=L.groups)==null?void 0:h.offset)&&((x=L.groups)==null?void 0:x.option)&&(A=A.add(Number(L.groups.offset),L.groups.option)),L.groups.type==="rfc1123"?M=A.toDate().toUTCString():L.groups.type==="iso8601"?M=A.toISOString():M=A.format(L.groups.type.slice(1,L.groups.type.length-1))}}else if($.startsWith("$localDatetime")){let L=/^\$localDatetime\s(?<type>rfc1123|iso8601|'.+'|".+")(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec($);if((q=L==null?void 0:L.groups)==null?void 0:q.type){let A=Ge.default.utc().local();((y=L.groups)==null?void 0:y.offset)&&((b=L.groups)==null?void 0:b.option)&&(A=A.add(Number(L.groups.offset),L.groups.option)),L.groups.type==="rfc1123"?M=A.locale("en").format("ddd, DD MMM YYYY HH:mm:ss ZZ"):L.groups.type==="iso8601"?M=A.format():M=A.format(L.groups.type.slice(1,L.groups.type.length-1))}}else $.startsWith("$processEnv")?M=process.env[$.slice("$processEnv".length).trim()]:$.startsWith("$dotenv")&&(M=r[$.slice("$dotenv".length).trim()]);M&&(s=s.replace(k,`${M}`))}return s}var Jn={};async function _o(t){var o;if(!c(t))return t;let e,r=t;for(;(e=g.javascript.scriptSingleLine.exec(t))!==null;){let[s,n]=e,i=/^\$input\s*(?<placeholder>[^$]*)(\$value:\s*(?<value>.*))?\s*$/u.exec(n);if((o=i==null?void 0:i.groups)==null?void 0:o.placeholder){let a=i.groups.placeholder,l=await O.showInputPrompt(a,Jn[a]||i.groups.value);if(l)Jn[a]=l,r=r.replace(s,`${l}`);else return S}}return r}async function Go(t){var o,s;if(!c(t))return t;let e,r=t;for(;(e=g.javascript.scriptSingleLine.exec(r))!==null;){let[n,i]=e,a=/^\$pick\s*(?<placeholder>[^$]*)(\$value:\s*(?<value>.*))\s*$/u.exec(i);if(((o=a==null?void 0:a.groups)==null?void 0:o.placeholder)&&((s=a==null?void 0:a.groups)==null?void 0:s.value)){let l=a.groups.placeholder,p=a.groups.value,d=await O.showListPrompt(l,p.split(","));if(d&&r)r=r.replace(n,`${d}`);else return S}}return r}var _;(function(h){h.aws="aws",h.basicAuth="basicAuth",h.clientCertificate="clientCertificate",h.digestAuth="digestAuth",h.escape="escape",h.oauth2="oauth2",h.host="host",h.intellijDynamic="intellijDynamic",h.restClientDynamic="restClientDynamic",h.javascript="javascript",h.showInputBox="showInputBox",h.showQuickPick="showQuickPick"})(_||(_={}));function ja(){let t=new kt;return t.addHook(_.showInputBox,_o),t.addHook(_.showQuickPick,Go),t.addHook(_.restClientDynamic,Uo),t.addHook(_.intellijDynamic,Fo),t.addHook(_.host,Ao),t.addHook(_.javascript,jo),t.addHook(_.oauth2,Vo),t.addHook(_.aws,Lo),t.addHook(_.clientCertificate,To),t.addHook(_.basicAuth,qo),t.addHook(_.digestAuth,Io),t.addHook(_.escape,$o),t}var Qn=v(require("lodash/merge")),Kn=v(require("chalk"));var Jt=class{constructor(){this.storeCache=[]}getFromStore(e,r){let o=f.toString(e),s=this.storeCache.find(n=>n.cacheKey===o);return s||(s={cacheKey:o,version:r},this.storeCache.push(s)),s}get(e){var o;let r=f.toString(e);return(o=this.storeCache.find(s=>s.cacheKey===r))==null?void 0:o.httpFile}getAll(){let e=[];for(let r of this.storeCache)r.httpFile&&e.push(r.httpFile);return e}getOrCreate(e,r,o,s){let n=this.getFromStore(e,o);return o>n.version||!n.httpFile?(n.promise&&o<=n.version||(n.promise=r().then(i=>this.parse(e,i,s)).then(i=>{if(delete n.promise,n.httpFile){for(let a of i.httpRegions){let l=n.httpFile.httpRegions.find(p=>p.symbol.source===a.symbol.source);l&&(a.variablesPerEnv=l.variablesPerEnv)}i.activeEnvironment=n.httpFile.activeEnvironment}return n.version=o,n.httpFile=i,i}).catch(i=>{throw delete n.promise,n.httpFile&&this.remove(n.httpFile.fileName),i})),n.promise):n.promise||Promise.resolve(n.httpFile)}async parse(e,r,o){let s=await this.initHttpFile(e,o);return await oo(s,r,this)}remove(e){let r=f.toString(e),o=this.storeCache.findIndex(s=>s.cacheKey===r);o>=0&&this.storeCache.splice(o,1)}rename(e,r){let o=f.toString(e),s=this.storeCache.find(n=>n.cacheKey===o);s&&(s.cacheKey=f.toString(r),s.httpFile&&(s.httpFile.fileName=r))}clear(){this.storeCache.length=0}async initHttpFile(e,r){var a,l;let o=await hr(e,r.workingDir,"package.json",...Ot,((a=r.config)==null?void 0:a.envDirName)||"env"),s={fileName:e,rootDir:o,hooks:{parse:Ho(),parseEndRegion:So(),replaceVariable:gt.initReplaceVariableHook(),provideEnvironments:Ue.initProvideEnvironmentsHook(),provideVariables:Ue.initProvideVariablesHook(),onRequest:zr(),onResponse:Yr(),responseLogging:new wt},httpRegions:[],activeEnvironment:r.activeEnvironment};r.config=await ht(r.config,s.rootDir);let n={};o&&(Object.assign(n,await kr(o)),((l=r.config)==null?void 0:l.configureHooks)&&(n[".httpyac.js"]=r.config.configureHooks));let i=process.env.HTTPYAC_PLUGIN;if(i)try{let p=require(i);p.configureHooks&&(n.HTTPYAC_PLUGIN=p.configureHooks)}catch(p){m.warn("Global Hook Plugin not loaded",p)}return await this.configureHooks(s,r,n),s}async configureHooks(e,r,o){if(r.config){let s={version:"1.0.0",rootDir:e.rootDir,config:r.config,httpFile:e,hooks:e.hooks,log:m,fileProvider:f,sessionStore:U,userInteractionProvider:O,getHookCancel:()=>S};for(let[n,i]of Object.entries(o))try{m.trace(`load ${n}`);let a=i(s);Fe(a)&&await a}catch(a){m.error(`error in ${n}`,a)}}}};async function ht(t,e){let r=[];if(e){let s=await xr(e);s&&r.push(s)}t&&r.push(t);let o=(0,Qn.default)({log:{level:E.warn,supportAnsiColors:!0},cookieJarEnabled:!0,envDirName:"env"},...r);return Da(o),o}function Da(t){var e,r,o;m.options.level=(r=(e=t==null?void 0:t.log)==null?void 0:e.level)!=null?r:E.warn,((o=t==null?void 0:t.log)==null?void 0:o.supportAnsiColors)===!1&&(Kn.default.level=0)}var Jo=class{constructor(){this.userSessions=[];this.sessionChangedListener=[]}onSessionChanged(e){return this.sessionChangedListener.push(e),()=>{let r=this.sessionChangedListener.indexOf(e);r>=0&&this.sessionChangedListener.splice(r,1)}}async reset(){for(let e of this.userSessions)e.delete&&e.delete();this.userSessions.length=0,this.notifySessionChanged()}getUserSession(e){return this.userSessions.find(r=>r.id===e)}setUserSession(e){this.removeUserSession(e.id),this.userSessions.push(e),this.notifySessionChanged()}notifySessionChanged(){for(let e of this.sessionChangedListener)e()}removeUserSession(e){let r=this.userSessions.find(o=>o.id===e);r&&(r.delete&&r.delete(),this.userSessions.splice(this.userSessions.indexOf(r),1),this.notifySessionChanged())}isUserSession(e){let r=e;return r&&!!r.description&&!!r.id&&!!r.title&&!!r.type&&!!r.details}},U=new Jo;async function Qt(t){let e=!1;return Hr(t)?e=await Ma(t):Sr(t)?e=await Ba(t):e=await Va(t),e}async function Ma(t){if(!t.httpRegion.metaData.disabled){let e=await Ko(t);if(await Me(e))return await ke(e,!0)}return!1}async function Ba(t){let e=await Ko(t);if(await Me(e)){for(let r of t.httpRegions)if(!r.metaData.disabled){let o=T(P({},e),{httpRegion:r});if(!await ke(o,!1))return!1}return!0}return!1}async function Va(t){let e=await Ko(t);for(let r of t.httpFile.httpRegions){if(r.metaData.disabled){m.debug(`${r.symbol.name} is disabled`);continue}if(r.request&&t.httpRegionPredicate&&!t.httpRegionPredicate(r)){m.debug(`${r.symbol.name} disabled by predicate`);continue}let o=T(P({},e),{httpRegion:r});await ke(o)}return!0}async function Ko(t){return Object.assign(t,{variables:await zn(t),httpClient:Er(t),options:{}})}async function zn(t){var o;t.config=await ht(t.config,(o=t.httpFile)==null?void 0:o.rootDir);let e=await t.httpFile.hooks.provideVariables.trigger(t.httpFile.activeEnvironment,t);if(e===S)return{};let r=Object.assign({},...e);return m.debug(r),r}async function Na(t){var r;t.config=await ht(t.config,(r=t.httpFile)==null?void 0:r.rootDir);let e=await t.httpFile.hooks.provideEnvironments.trigger(t);return e!==S&&e.length>0?e.reduce((o,s)=>{for(let n of s)o.indexOf(n)<0&&o.push(n);return o},[]).sort():[]}var ts={};ie(ts,{execute:()=>Ja});var es=v(require("inquirer")),ti=v(require("fs")),ri=v(require("path"));var oi=v(require("globby"));var zo=v(require("arg"));var Pe;(function(e){e.onlyFailed="only-failed"})(Pe||(Pe={}));function Yo(t){if(t.json)return E.none;if(t.silent)return E.error;if(t.verbose)return E.trace}function Yn(t){try{let e=(0,zo.default)({"--all":Boolean,"--bail":Boolean,"--editor":Boolean,"--env":[String],"--filter":String,"--help":Boolean,"--insecure":Boolean,"--interactive":Boolean,"--json":Boolean,"--line":Number,"--name":String,"--no-color":Boolean,"--output":String,"--output-failed":String,"--raw":Boolean,"--quiet":Boolean,"--repeat":Number,"--repeat-mode":String,"--silent":Boolean,"--timeout":Number,"--verbose":Boolean,"--version":Boolean,"-e":"--env","-h":"--help","-i":"--interactive","-l":"--line","-n":"--name","-o":"--output","-s":"--silent","-v":"--verbose"},{argv:t.slice(2)});return{activeEnvironments:e["--env"],allRegions:e["--all"],bail:e["--bail"],editor:e["--editor"],fileName:e._.length>0?e._[e._.length-1]:void 0,filter:e["--filter"],help:e["--help"],httpRegionLine:e["--line"],httpRegionName:e["--name"],interactive:e["--interactive"],json:e["--json"],output:e["--output"],outputFailed:e["--output-failed"],raw:e["--raw"],rejectUnauthorized:e["--insecure"]!==void 0?!e["--insecure"]:void 0,repeat:e["--repeat"]?{count:e["--repeat"],type:e["--repeat-mode"]==="sequential"?ve.sequential:ve.parallel}:void 0,requestTimeout:e["--timeout"],silent:e["--silent"],verbose:e["--verbose"],version:e["--version"]}}catch(e){e instanceof zo.default.ArgError?console.error(e.message):console.error(e)}}function Xn(){console.info(`send http requests of .http or .rest

usage: httpyac [options...] <file or glob pattern>
       --all           execute all http requests in a http file
       --bail          stops when a test case fails
       --editor        enter a new request and execute it
  -e   --env           list of environemnts
       --filter        filter requests output (only-failed)
  -h   --help          help
       --insecure      allow insecure server connections when using ssl
  -i   --interactive   do not exit the program after request, go back to selection
       --json          use json output
  -l   --line          line of the http requests
  -n   --name          name of the http requests
       --no-color      disable color support
  -o   --output        output format of response (short, body, headers, response, exchange, none)
       --output-failed output format of failed response (short, body, headers, response, exchange, none)
       --raw           prevent formatting of response body
  -r   --repeat        repeat count for requests
       --repeat-mode   repeat mode: sequential, parallel (default)
  -s   --silent        log only request
       --timeout       maximum time allowed for connections
  -v   --verbose       make the operation more talkative
       --version       version of httpyac`)}function Xo(t,e){return t+e}function Zn(t,e){let r=[];for(let[o,s]of Object.entries(t))r.push(...s.map(n=>{var a,l,p,d,u,h,x,q,y,b;return{fileName:o,response:Ua(n.response,e.outputFailed&&((l=(a=n.testResults)==null?void 0:a.some)==null?void 0:l.call(a,k=>!k.result))?e.outputFailed:e.output),name:(p=n.metaData)==null?void 0:p.name,title:(d=n.metaData)==null?void 0:d.title,description:(u=n.metaData)==null?void 0:u.description,line:n.symbol.startLine,testResults:n.testResults,summary:{totalTests:((h=n.testResults)==null?void 0:h.length)||0,failedTests:((q=(x=n.testResults)==null?void 0:x.filter)==null?void 0:q.call(x,k=>!k.result).length)||0,successTests:((b=(y=n.testResults)==null?void 0:y.filter)==null?void 0:b.call(y,k=>!!k.result).length)||0}}}));return{_meta:{version:"1.0.0"},requests:e.filter===Pe.onlyFailed?r.filter(o=>o.summary.failedTests>0):r,summary:{totalRequests:r.length,failedRequests:r.filter(o=>o.summary.failedTests>0).length,successRequests:r.filter(o=>o.summary.failedTests===0).length,totalTests:r.map(o=>o.summary.totalTests).reduce(Xo,0),failedTests:r.map(o=>o.summary.failedTests).reduce(Xo,0),successTests:r.map(o=>o.summary.successTests).reduce(Xo,0)}}}function Ua(t,e){var r;if(t)switch(delete t.rawBody,delete t.prettyPrintBody,delete t.parsedBody,delete t.contentType,e){case"body":case"response":return delete t.request,t;case"short":return delete t.body,delete t.request,t;case"none":return;case"headers":return delete t.body,(r=t.request)==null||delete r.body,t;case"exchange":default:return t}}var Te=v(require("fs")),We=v(require("path")),Kt=v(require("inquirer")),Zo=v(require("clipboardy"));function ei(){_a(),Wa()}function _a(){f.isAbsolute=async t=>(0,We.isAbsolute)(f.toString(t)),f.dirname=t=>(0,We.dirname)(f.toString(t)),f.joinPath=(t,e)=>(0,We.join)(f.toString(t),e),f.exists=async t=>{try{return!!await Te.promises.stat(f.toString(t))}catch{return!1}},f.readFile=async(t,e)=>{let r=f.fsPath(t);return Te.promises.readFile(r,e)},f.readBuffer=async t=>{let e=f.fsPath(t),r=(0,Te.createReadStream)(e);return Ga(r)},f.writeBuffer=(t,e)=>Te.promises.writeFile(f.toString(t),e),f.readdir=async t=>Te.promises.readdir(f.toString(t))}function Ga(t){return new Promise((e,r)=>{let o=[];t.on("data",s=>{Buffer.isBuffer(s)?o.push(s):o.push(Buffer.from(s))}),t.on("end",()=>e(Buffer.concat(o))),t.on("error",s=>r(s)),t.resume()})}function Wa(){O.showNote=async function(e){return(await Kt.default.prompt([{type:"confirm",name:"note",message:e}])).note},O.showInputPrompt=async function(e,r){return(await Kt.default.prompt([{type:"input",name:"placeholder",message:e,default:r}])).placeholder},O.showListPrompt=async function(e,r){return(await Kt.default.prompt([{type:"list",name:"placeholder",message:e,choices:r}])).placeholder},O.getClipboard=async function(){return await Zo.default.read()},O.setClipboard=async function(e){await Zo.default.write(e)}}var si=v(require("chalk"));async function Ja(t){ei();let e=Yn(t);if(!!e){if(e.version){let r=await it((0,ri.join)(__dirname,"../package.json"));console.info(`httpyac v${r==null?void 0:r.version}`);return}if(e.help){Xn();return}process.platform==="win32"&&(le.ok="[x]",le.error="[-]");try{let r=Qa(e),o=await za(e,r.config);if(o.length>0){let s=!0,n={};for(;e.interactive||s;){let i=await Ya(o,e),a=[];if(i)await Qt(Object.assign({processedHttpRegions:a},r,i)),n[f.toString(i.httpFile.fileName)]=[...a];else for(let l of o)!e.json&&r.scriptConsole&&o.length>1&&r.scriptConsole.info(`--------------------- ${l.fileName}  --`),await Qt(Object.assign({processedHttpRegions:a},r,{httpFile:l})),n[f.toString(l.fileName)]=[...a],a.length=0;if(s=!1,e.json||Object.keys(n).length>1||Object.entries(n).some(([,l])=>l.length>1)){let l=Zn(n,e);e.json?console.info(JSON.stringify(l,null,2)):r.scriptConsole&&(r.scriptConsole.info(""),r.scriptConsole.info(si.default`{bold ${l.summary.totalRequests}} requests tested ({green ${l.summary.successRequests} succeeded}, {red ${l.summary.failedRequests} failed})`))}}}else{console.error(`httpYac cannot find the specified file ${e.fileName}.`);return}}catch(r){throw console.error(r),process.exitCode||(process.exitCode=1),r}finally{process.exit()}}}function Qa(t){return{repeat:t.repeat,scriptConsole:new pt({level:Yo(t),onlyFailedTests:t.filter===Pe.onlyFailed}),config:{log:{level:Yo(t)},request:{timeout:t.requestTimeout,https:{rejectUnauthorized:t.rejectUnauthorized}}},logStream:t.json?void 0:Za(t),logResponse:t.json?void 0:el(t)}}function Ka(t,e){if(t.length>0&&e.bail){let r={afterTrigger:async function(s){var i,a;let n=(a=(i=s.arg.httpRegion.testResults)==null?void 0:i.find)==null?void 0:a.call(i,l=>!l.result);if(n)throw n.error||new Error("bail on failed test");return!0}};for(let o of t)o.httpRegions.forEach(s=>s.hooks.execute.addInterceptor(r))}}async function za(t,e){let r=[],o=new Jt,s={workingDir:process.cwd(),activeEnvironment:t.activeEnvironments,config:e};if(t.editor){let n=await es.default.prompt([{type:"editor",message:"input http request",name:"httpFile"}]),i=await o.getOrCreate(process.cwd(),async()=>n.httpFile,0,s);r.push(i)}else if(t.fileName){let n=await(0,oi.default)(t.fileName,{expandDirectories:{files:["*.rest","*.http"],extensions:["http","rest"]}});for(let i of n){let a=await o.getOrCreate(i,async()=>await ti.promises.readFile(i,"utf8"),0,s);r.push(a)}}return Ka(r,t),r}async function Ya(t,e){if(t.length===1){let r=t[0],o=Xa(r,e);if(o)return{httpFile:r,httpRegion:o}}if(!e.allRegions){let r={},o=t.length>1;for(let n of t){r[o?`${n.fileName}: all`:"all"]={httpFile:n};for(let i of n.httpRegions)if(i.request){let a=i.symbol.name;r[o?`${n.fileName}: ${a}`:a]={httpRegion:i,httpFile:n}}}let s=await es.default.prompt([{type:"list",name:"region",message:"please choose which region to use",choices:Object.entries(r).map(([n])=>n)}]);if(s.region&&r[s.region])return r[s.region]}return!1}function Xa(t,e){let r=!1;return e.httpRegionName?r=t.httpRegions.find(o=>o.metaData.name===e.httpRegionName)||!1:r=t.httpRegions.find(o=>e.httpRegionLine&&o.symbol.startLine<=e.httpRegionLine&&o.symbol.endLine>=e.httpRegionLine)||!1,r}function Za(t){if(t.output!=="none")return async function(r,o,s){let n=Buffer.isBuffer(s)?s.toString("utf-8"):s;console.info(`${new Date().toLocaleTimeString()} - ${o}: `,n)}}function el(t){let e=ni(t.output,t.filter===Pe.onlyFailed,!t.raw);if(e)return ar(console.info,e,t.outputFailed?ni(t.outputFailed,t.filter===Pe.onlyFailed,!t.raw):void 0)}function ni(t,e,r){switch(t){case"body":return{responseBodyLength:0,responseBodyPrettyPrint:r,onlyFailed:e};case"headers":return{requestOutput:!0,requestHeaders:!0,responseHeaders:!0,onlyFailed:e};case"response":return{responseHeaders:!0,responseBodyPrettyPrint:r,responseBodyLength:0,onlyFailed:e};case"none":return;case"short":return{useShort:!0,onlyFailed:e};case"exchange":default:return{requestOutput:!0,requestHeaders:!0,responseBodyPrettyPrint:r,requestBodyLength:0,responseHeaders:!0,responseBodyLength:0,onlyFailed:e}}}0&&(module.exports={ActionType,BailSeriesHook,ExecuteHook,Hook,HookCancel,HttpSymbolKind,LogLevel,OnRequestHook,OnResponseHook,OnStreaming,ParseEndRegionHook,ParseHook,ProtoDefinition,ProvideEnvironmentsHook,ProvideVariablesHook,RepeatOrder,ReplaceVariableHook,ResponseLoggingHook,SeriesHook,VariableType,WaterfallHook,actions,cli,getEnvironments,getVariables,io,isProcessorContext,parser,send,store,testSymbols,utils,variables});
//# sourceMappingURL=index.js.map
